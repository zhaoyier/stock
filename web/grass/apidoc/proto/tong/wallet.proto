syntax                                    = "proto3";
package tong;
import "common/ezbuy.proto";

service Wallet {
    //option (common.service).cacheMemoryLimit = "3G";

    // 列举指定国家支持的支付方式
    rpc ListPayType(WalletListPayType) returns (WalletPayTypeListResp);

    // 开户
    rpc CreateWallet(WalletCustomer) returns (AccountBalanceAndResp);

    // 销户
    rpc DestroyWallet(WalletCustomer) returns (AccountBalanceAndResp);

    // 请求生成钱包操作存根
    // 这个存根的用途是防止重复操作，保证帐户变动接口的幂等性
    // 存根生成后，会缓存起来，当收到请求并成功完成操作后，存根被消毁。
    // 后续相同的请求将会因为找不到存根而被忽略。
    rpc GenWalletStub(WalletCoreParameter) returns (WalletStub);

    // 请求充值
    rpc TopUp(WalletTopUp) returns (WalletTopUpResp);

    // 查询充值结果
    rpc QueryTopUpStatus(WalletQueryTopUpStatus) returns (WalletQueryTopUpStatusResp){
        option (common.timeout) = "60s";
    }

    // 用支付平台的流水号来查看对应的充值请求参数，为了兼容老平台
    rpc GetTopUpArg(ThirdRawSerial) returns (WalletTopUpArgResp);

    // 确认充值到帐
    rpc ConfirmTopUp(WalletInstruct) returns (WalletInstructResp);

    // 审核充值
    rpc DoubleCheckTopUp(WalletInstruct) returns (WalletInstructResp);

    // 礼品卡/积分 兑换 返利款
    rpc Exchange(WalletExchange) returns (AccountBalanceAndResp);

    // 退款
    rpc Refund(WalletRefund) returns (AccountBalanceAndResp);

    // 申请提现
    rpc Withdraw(WalletWithdraw) returns (WalletTopUpResp);

    //  批准提现
    rpc ReplyWithdraw(WalletInstruct) returns (WalletInstructResp);

    // 提现出错被退回
    rpc GiveBackWithdraw(WalletInstruct) returns (WalletInstructResp);

    // 确认提现完成
    rpc ConfirmWithdraw(WalletInstruct) returns (WalletInstructResp);

    // 扣款用于支付帐单
    rpc Deduct(WalletDeduct) returns (AccountBalanceAndResp){
        option (common.timeout) = "60s";
    }

    rpc CacultePayFee(WalletPayType) returns (WalletPayFee);

    //-------------------

    // 列举待确认的充值
    rpc ListPendingTopUp(WalletPagedQuery) returns (WalletTopUpListResp);

    // 列举待审核的充值
    rpc ListDoubleCheckingTopUp(WalletPagedQuery) returns (WalletTopUpListResp);

    // 查询钱包帐户余额
    rpc GetBalance(WalletGetBalance) returns (WalletGetBalanceResp);

    // 列举钱包流水
    rpc ListJournal(WalletListJournal) returns (WalletListJournalResp);

    //--------------------
    // Tokenization 相关
    rpc ListCardToken(WalletCustomer) returns (CardTokenListResp);

    rpc CreateCardToken(WalletCardInfo) returns (WalletCardInfoResp);
    rpc DeleteCardToken(WalletDelCard) returns (Result);

    rpc GetCardInfo(WalletGetCardInfo) returns (WalletCardInfoResp);

    //--------------------
    // citibank虚拟帐号 相关
    rpc GetCitiBankVirtualAccount(WalletCustomer) returns (WalletCitiBankVirtualAcct){
        option (common.cache).enableClientSideCache = true;
        option (common.cache).enableServerSideCache = true;
        option (common.cache).cacheExpired = "60s";
    }
    rpc GetCusmoterFromCitiBankAccount(WalletCitiBankVirtualAcctReq) returns (WalletCitiBankVirtualAcct){
        option (common.cache).enableClientSideCache = true;
        option (common.cache).enableServerSideCache = true;
        option (common.cache).cacheExpired = "60s";
    }

    rpc BatGetCitiBankVirtualAccount(MultiWalletCustomer) returns (MutilWalletCitiBankVirtualAcct);
    rpc BatGetCusmoterFromCitiBankAccount(MultiWalletCitiBankVirtualAcctReq) returns (MutilWalletCitiBankVirtualAcct);

    rpc GetBankAccountList(WalletCustomer) returns (WalletBankResp);
}

// ---------------------------------------------------------------------------

//! 通用响应
message Result {
    int32 code                            = 1; // 0表示成功，其他表示失败
    string     message                    = 2;
}

// 基础参数，用于对接口的访问鉴权
message WalletCoreParameter {
    string CountryCode                    = 1; // 国家
    string Token                          = 2; // 访问权限控制，token会事先分配给有访问权限的进程
}

message WalletCustomer {
    WalletCoreParameter CParam            = 1; // 国家
    int64 CustomerID                      = 2; // 用户ID
}

message MultiWalletCustomer {
    WalletCoreParameter CParam            = 1; // 国家
    repeated int64 CustomerID             = 2; // 用户ID
}

// 个存根的用途是防止重复操作，保证帐户变动接口的幂等性
message WalletStub {
    Result Result                         = 1;
    string Stub                           = 2; // n_X; n部分为unix时间戳，是stub的过期时间；X部分是一串随机数
}

message WalletListPayType {
    WalletCoreParameter CParam            = 1; // 国家
    int64 CustomerID                      = 2; // 用户ID
    int64 BillAmount                      = 3; // 订单金额
}

message CardTokenDesc {
    string CardToken                      = 1; // 信用卡的token,代表一张信用卡
    string CardIIN                        = 2; // 卡前6位，用于识别发卡机构
    string CardLastNo                     = 3; // 卡的后4位
    int64 ExpireYear                      = 4; // 卡的过期日期
    int64 ExpireMonth                     = 5;
    string Brand                          = 6; // 发卡机构
    int64 Fee                             = 7; /* 信用卡手续费，在列举信列表时，如果提供了订单金额则计算好手续费返回给客户端
                                                    这样做的可以避免不同的客户端的浮点运算的精度误差。还有如果信用卡有什么特殊
                                                    的优惠活动，可以不用客户端更新版本*/
    int32 NeedOTPFlag                     = 8; // 客户端在支付时是否有必要去做OTP验证
    string CardFinger                     = 9; // 卡的指纹
    string Funding                        = 10; // 卡类型; credit/debit/prepaid
}

// 支付方式按 (PayMethod, PayPlatform) 这样的两层关系组织
// 该组合唯一标识一种支付方式，PayType是赋值给它的ID
message PayType {
    int32 PayType                         = 1; // 支付方式ID
    string CurrencyCode                   = 2; // 货币代码
    repeated PayChannel PayChannel        = 3; // 收款银行名称/支付渠道名称
    string Description                    = 4;
    int64 FeeRateMille                    = 8; // 服务费率，千分数
    string PayMethod                      = 9; // 支付方式 [Manual, E-Banking, PayPlatform, ...]
    string PayPlatform                    = 10; // 支付平台
    repeated CardTokenDesc CardList       = 11; // 用户已经保存的信用卡列表
    repeated string IconURLs              = 12; // 支付图标的ICON资源连接
}

message PayChannel {
    string Name = 1;   // 通道名称
    string Code = 2;
    string Desc = 3;   // 通道说明
    string IconUrl = 4; // 通道ICON
}

message WalletPayTypeListResp {
    repeated PayType AllPayType           = 1;
    string Stub                           = 2; // n_X; n部分为unix时间戳，是stub的过期时间；X部分是一串随机数
    Result Result                         = 15;
}

message WalletRelatedBill {
    int64  BillId = 1;               // 账单id
    string BillType = 2;            // 账单类型
    string BillNumber = 3;          // PaymentNumber
}

message WalletTopUp {
    WalletCoreParameter CParam            = 1; // 基础参数，用于对接口的访问鉴权
    string Stub                           = 2; // n_X; n部分为unix时间戳，是stub的过期时间；X部分是一串随机数
    int64 CustomerID                      = 3;
    int64 Amount                          = 4;
    int32 PayType                         = 5; // 支付方式
    string BillID                         = 6; // 帐单ID
    int64 BillAmount                      = 7; // 帐单金额
    string OTPToken                       = 8; // 对应stripe的3D secure source, 代表用户正在做的支付安全认证过程
    string CardToken                      = 9; // 代表一张信用卡token
    int32 ClientType                      = 10; // 客户端类型
    string TopUpNumber                    = 11; // 为了兼容老系统，当该字段有值时，佟掌握不生成journalnum,直接使用这个值
    string FromBankName                   = 12;
    string FromAccount                    = 13;
    string RawSerial                      = 14; // 银行的转帐流水号，仅在ATM和i-Banking两种转帐方式填写
    int64 CreateTime                      = 15; 
    string Note                           = 16;
    int64 Fee                             = 17; //手续费, 已经被包含在Amount中
    string ToBank                         = 18; // ATM和i-Banking方式时填写收款的银行名称; 另外Molpay使用这个字段传入channel code参数
    string AgentCode                      = 19; // 泰国123支付方式时，填写线下收款代理代码，比如便利店名称
    string CouponSN                       = 20; // 支付时使用该优惠码，享受优惠价
    string Phone                          = 21;
    repeated WalletRelatedBill Bills      = 22;
}

message WalletTopUpResp {
    string JournalNumber                  = 1; // 钱包流水序列号
    int64 Amount                          = 3;
    string FromBankName                   = 4;
    string PayProviderURL                 = 5; // 不同支付方式下，引导用户跳转的URL或者是要提交的表单内容
    string PayProviderURL4App             = 6; // 不同支付方式下，APP端引导用户跳转的URL或者是要提交的表单内容
    int32 SyncCompleteFlag                = 7; // >0: 无需异步流程，支付已经成功
    string RawSerial                      = 8; // 支付平台流水号
    Result Result                         = 15;
}

message ThirdRawSerial {
    WalletCoreParameter CParam            = 1; // 基础参数，用于对接口的访问鉴权
    int32 PayType                         = 2;
    string RawSerial                      = 3;
}

message WalletTopUpArgResp {
    Result     Result                     = 1;
    int64 CustomerID                      = 2;
    int64 Amount                          = 3;
    string JournalNumber                  = 4; // 钱包流水序列号
    string CountryCode                    = 5;
    string TopUpNumber                    = 10; // 为了兼容老系统，当该字段有值时，佟掌握不生成journalnum,直接使用这个值
}

message WalletQueryTopUpStatus {
    WalletCoreParameter CParam            = 1;
    int64 CustomerID                      = 2;
    string JournalNumber                  = 3; // 钱包流水序列号
}

message WalletQueryTopUpStatusResp {
    /*
        TOPUP_INIT_ST                     = 0
        TOPUP_PENDING_ST                  = 1
        TOPUP_DOUBLE_CHECK_ST             = 2
        TOPUP_CANCEL_ST                   = 903
        TOPUP_CONFIRMED_ST                = 904
    */
    int32 JournalStatus                   = 1;
    Result Result                         = 2;
}

message WalletInstruct {
    WalletCoreParameter CParam            = 1;
    int32 OperCode                        = 2; // 0-通过; 1-拒绝; 2-实际收到和请求不一样;
    int64 CustomerID                      = 3;
    string JournalNumber                  = 4; // 钱包流水序列号
    string RawSerial                      = 5; // 第三方支付平台的流水号, 在确认提现到帐后时请填写银行的转帐流水号
    string Operator                       = 6; // 是谁做的确认到帐操作
    int64 Amount                          = 7; // 确认到帐金额
    string Note                           = 8; // 操作备注
    int32 PayType                         = 9;
}

// 因为该接口是ERP调用。工作人员并不关心用户帐户的余额
message WalletInstructResp {
    Result     Result                     = 1;
}

message WalletExchange {
    enum RebateCode {
        GIFT_CARD                         = 0; // 礼品卡
        CREDITS                           = 1; // 积分
    }

    WalletCoreParameter CParam            = 1;
    int64 CustomerID                      = 2;
    int64 Amount                          = 3;
    RebateCode ExType                     = 4; // 通过礼品卡还是积分兑换
    string Note                           = 5;
    string BillID                         = 6; // 用户的兑换纪录ID，从支付的视角，把它也看成一个帐单
    string Stub                           = 7; // n_X; n部分为unix时间戳，是stub的过期时间；X部分是一串随机数
}

message WalletBalance {
    int64 CustomerID                      = 1;
    int64 UpdateTime                      = 2;
    string UpdateBy                       = 3;
    int64 Balance                         = 4;
    int64 RebateBalance                   = 5;
    int64 CreditCardBalance               = 6;
    int64 AvailBalance                    = 7;
}

// 因为该响应很可能展现给用户。所以在响应中给出余额信息
message AccountBalanceAndResp {
    Result     Result                     = 1;
    string JournalNumber                  = 2; // 钱包流水序列号
    WalletBalance Balance                 = 3; // 钱包余额
}

message WalletRefund {
    WalletCoreParameter CParam            = 1;
    int64 CustomerID                      = 2;
    int64 Amount                          = 3;
    string Note                           = 5;
    string OriginJournalNumber            = 6; // 原来的付款流水ID，必填，因为要通过它才能确定退款的去向
    string Operator                       = 7; // 操作人
    string BillID                         = 12; // 帐单ID
    string Stub                           = 13; // n_X; n部分为unix时间戳，是stub的过期时间；X部分是一串随机数
    int32 RequestID                      = 14; // 由支付约定的调用方id 0 order  1 prime 
}


message WalletWithdraw {
    WalletCoreParameter CParam            = 1;
    int64 CustomerID                      = 2;
    int64 Amount                          = 3;
    string ToBankName                     = 8;
    string ToAccount                      = 9;
    string Note                           = 5;
    bool IsBackToCreditCard               = 12;
    string Stub                           = 13; // n_X; n部分为unix时间戳，是stub的过期时间；X部分是一串随机数
}

message WalletDeduct {
    WalletCoreParameter CParam            = 1;
    int64 CustomerID                      = 2;
    int64 Amount                          = 3;
    string Note                           = 5;
    int32 PlatformId                      = 6; // 客户端类型
    bool AllowOweMoney                    = 7; // 是否允许扣款产生赊欠
    string BillID                         = 12; // 帐单ID
    string Stub                           = 13; // n_X; n部分为unix时间戳，是stub的过期时间；X部分是一串随机数
    int32 RequestID                      = 14; // 由支付约定的调用方id 0 order  1 prime 
}

message WalletPagedQuery {
    WalletCoreParameter CParam = 1;
    int32 Offset               = 2;
    int32 Limit                = 3;
    string TopupNumber         = 4;
    string CustomerEmail       = 5;
    string Nickname            = 6;
    int64 Amount               = 7;
    int64 Begin                = 8;
    int64 End                  = 9;
    string BankName            = 10;
    int32 Status               = 11;
    int32 BillType             = 12; // 0-all; 1-代购; 2-Ezbuy; 3-Prime
}

message WalletJournal {
    string JournalNumber                  = 1;
    int64 Amount                          = 2;
    int64 CustomerID                      = 3;
    string FromBankName                   = 4;
    string FromAccount                    = 5;
    string ToBankName                     = 6;
    string ToBankAccount                  = 7;
    int32 Status                          = 8;
    int64 UpdateTime                      = 9;
    string UpdateBy                       = 10;
    int32 JournalType                     = 11;
    int32 PayType                         = 12;
    string RawSerial                      = 13;
    string PhoneNumber                    = 14;
}

message WalletTopUpListResp {
    repeated WalletJournal TopUpList      = 1;
    Result     Result                     = 2;
}

message WalletGetBalance {
    WalletCoreParameter CParam            = 1;
    int64 CustomerID                      = 2;
}

message WalletGetBalanceResp {
    Result     Result                     = 1;
    WalletBalance balance                 = 2;
}

message WalletListJournal {
    WalletPagedQuery PageQuery            = 1;
    int64 CustomerID                      = 5;
}

message WalletListJournalResp {
    repeated WalletJournal JournalList    = 1;
    Result     Result                     = 2;
}

message WalletCardInfo {
    WalletCustomer Customer               = 1;
    CardTokenDesc TokenDesc               = 2;
    int32  PayType                        = 3;
    string HolderName                     = 4;
    string AddressCity                    = 5;
    string AddressCountry                 = 6;
    string AddressLine1                   = 7;
    string AddressLine2                   = 8;
    string AddressState                   = 9;
    string AddressZip                     = 10;
}

message WalletGetCardInfo {
    WalletCoreParameter CParam            = 1;
    string CardToken                      = 2; // 信用卡的token,代表一张信用卡
    string CardFinger                     = 3; // 信用卡的唯一标识,代表一张信用卡
    int32 PayType                         = 4; // 用哪种支付方式生成的信用卡token
}

message WalletCardInfoResp {
    Result     Result                     = 1;
    CardTokenDesc TokenDesc               = 2;
}

message CardTokenListResp {
    Result     Result                     = 1;
    repeated  CardTokenDesc TokenDescList = 2;
}

message WalletCardTokenDesc {
    WalletCustomer Customer               = 1;
    CardTokenDesc CardDesc                = 2;
}

message CardTokenInfoRsp {
    string TokenID                        = 1;
    int32 PayType                         = 2;
    Result     Result                     = 3;
}

message WalletPayType {
    WalletCoreParameter CParam            = 1; // 基础参数，用于对接口的访问鉴权
    int32 PayType                         = 2;
    int64 BillAmount                      = 3;
}

message WalletPayFee {
    Result     Result                     = 1;
    int64      PayFee                     = 2;
}

message WalletCitiBankVirtualAcct {
    Result     Result                     = 1;
    string     CitiBankVirtualAccount     = 2;
    int64      CustomerID                 = 3; // 用户ID
}

message CitiBankPairs {
    string     CitiBankVirtualAccount     = 2;
    int64      CustomerID                 = 3; // 用户ID
}

message MutilWalletCitiBankVirtualAcct {
    Result     Result                        = 1;
    repeated CitiBankPairs CustomerVirAcct   = 2;
}

message WalletCitiBankVirtualAcctReq {
    WalletCoreParameter CParam            = 1; // 基础参数，用于对接口的访问鉴权
    string     CitiBankVirtualAccount     = 2;
}

message MultiWalletCitiBankVirtualAcctReq {
    WalletCoreParameter CParam                     = 1; // 基础参数，用于对接口的访问鉴权
    repeated string     CitiBankVirtualAccount     = 2;
}

message WalletDelCard {
    WalletCustomer Customer             = 1;
    string      SourceToken             = 2;    //要删除的 source token
    int32       PayType                 = 3;    
}

message WalletBank {
    string Name    = 1;
    string Code    = 2;
    string Account = 3;
    string Link    = 4;
    string Desc    = 5;
    string Extral  = 6; //银行账号状态  推荐/禁用
    string Icon    = 7;
}
 
message WalletBankResp {
    Result Result = 1;
    repeated WalletBank Banks = 2;
}
