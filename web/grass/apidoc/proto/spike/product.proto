syntax = "proto3";
package spike;
import "spike/product_entity.proto";
import "common/empty.proto";
import "common/time.proto";
import "common/common.proto";
import "spike/product_event.proto";
import "common/ezbuy.proto";
import "spike/item.proto";

service Product {
	// 申请一个 pid, 需要提供商品来源
	rpc Gpid(ProductGpid) returns (ProductGpidResp);
	// 通过 url/refId 获取商品的gpid
	rpc GetGpid(ProductGetGpid) returns (ProductGetGpidResp);
	// 根据RefId, Gpid, Url可以获取全部信息
	rpc Meta(ProductMeta) returns (ProductMetaResp);

	// 获取商品单体
	rpc Get(ProductGet) returns (ProductGetResp);
	rpc MultiGet(ProductMultiGet) returns (ProductMultiGetResp);
	// 商品搜索, 可以提供ES条件
	rpc Search(ProductSearch) returns (ProductSearchResp);
	// Update
	rpc Update(ProductUpdate) returns (ProductUpdateResp);
	// 处理商品下架
	rpc SetOnSale(ProductSetOnSale) returns (common.Empty);
	// 更新到ElasticSearch
	rpc SyncToes(ProductSyncToes) returns (common.Empty);

	// 商品入库
	rpc SimpleNew(ProductSimpleNew) returns (ProductSimpleNewResp);

	// 获取商品的简单信息
	rpc SimpleInfo(ProductSimpleInfo) returns (ProductSimpleInfoResp);
	rpc SimpleInfoMulti(ProductSimpleInfoMulti) returns (ProductSimpleInfoMultiResp);
	// 获取商品的的Sku
	rpc Sku(ProductSku) returns (ProductSkuResp);
	rpc SkuGetAllWeight(ProductId) returns (ProductAllSkuWeightResp);
	// 更新商品 Sku
	// webapi: admin
	rpc SkuAllWeightUpdate(ProductSkuWeightUpdate) returns (ProductSkuWeightUpdateResp);
	rpc SkuSetWeight(ProductSkuSetWeight) returns (ProductSkuSetWeightResp);

	rpc SellerSimple(ProductSellerSimple) returns (ProductSellerSimpleResp);

	// 设置卖家搜索, 访问屏蔽
	rpc BlockVendor(ProductBlockVendor) returns (ProductBlockVendorResp);
	rpc GetBlockVendor(ProductGetBlockVendor) returns (ProductGetBlockVendorResp);
	rpc StreamBlockVendor(ProductGetBlockVendor) returns (stream ProductGetBlockVendorResp);

	// 商品修改信息
	rpc ChangeLog(ProductChangeLog) returns (ProductChangeLogResp);
	// 获取更新
	rpc Subscribe(stream ProductSubscribe) returns (stream ProductSubscribeResp);
	rpc ReloadUpdateES(common.Empty) returns (common.Empty);

	//商品活动信息
	//添加更新操作
	rpc AddEvent(ProductAddEvent) returns (common.Empty);
	rpc EventUnshelve(ProductEventUnshelve) returns (common.Empty);
	rpc EventSearch(ProductEventSearch) returns (ProductEventSearchResp);
	rpc EventBatchUnshelve(ProductEventBatchUnshelve) returns (ProductEventBatchUnshelveResp);
	//查看当前的活动
	rpc Events(ProductEvents) returns (ProductEventsResp);
	// 单品商品抓取
	rpc Taobao(ProductTaobao) returns (ProductTaobaoResp);

	//随机提供淘宝商品信息
	rpc RandomTaoBaoItems(ProductRandomTaoBaoItems) returns (ProductRandomTaoBaoItemsResp);

	// 更新 tcid 下商品赋重
	rpc UpdateTCidWeight(TCidWeight) returns (UpdateTCidWeightResp);

	// 更新卖家 sku, 临时接口, 越早废弃越好
	rpc TempUpdateSellerSku(ProductTempUpdateSellerSku) returns (ProductTempUpdateSellerSkuResp);

  rpc Walk(ProductWalk) returns (ProductWalkResp) {
	option (common.timeout) = "60s";
  };
}

// ---------------------------------------------------------------------------
message ProductAddEvent {
	ProductId productId = 1;
	int64 start = 2;
	int64 expire = 3;
	EventType eventType = 4;
	string eventId = 5;

	repeated string catalogs = 6;
}

message ProductEventUnshelve {
	ProductId productId = 1;
	EventType eventType = 2;
	string eventId = 3;
}

message ProductEventSearch {
	int64 start = 1;
	int64 expire = 2;
	EventType eventType = 3;
	string catalog = 4;
	string lang = 5;

	int32 limit = 6;
	int32 offset = 7;
}

message ProductEventSearchResp {
	int64 total = 1;
	repeated ProductEntity entity = 2;
}

message ProductEventBatchUnshelve {
	//每次限制数量1000个
	repeated ProductEventUnshelve eventUnshelve = 1;
}

message ProductEventBatchUnshelveResult{
	int64 gpid = 1; //返回操作失败的gpid
	string errStr = 2; // 失败的原因
}

message ProductEventBatchUnshelveResp {
	repeated ProductEventBatchUnshelveResult results = 1;
}

message ProductEvents{
	ProductId productId = 1;
}

message ProductEventsResp {
	repeated ProductEventItem eventItems = 1;
}

// ---------------------------------------------------------------------------



// ---------------------------------------------------------------------------

message ProductId {
	int64 gpid = 1;
	string refId = 2;
}

// ---------------------------------------------------------------------------

enum ProductSource {
	ProductSourceInvalid = 0;
	ProductSourceEzbuy = 10;
	ProductSourceTaobao = 20;
	ProductSourceMomoso = 31;
	ProductSourceKorea = 32;
	ProductSourceBestbuy = 33;
	ProductSourceAldoshoes = 34;
	ProductSourceCarters = 35;
	ProductSourceTimberland = 36;
	ProductSourceColourpop = 37;
	ProductSourceCalphlauren = 38;
	ProductSourceAmazon = 39;
	ProductSourceWalmart = 40;
	ProductSourceSixpm = 41;
	ProductSourceNike = 42;
	ProductSourceRalphlauren = 43;
	ProductSourceTemp = 50;
}

message ProductGpid {
	ProductSource source = 1;
}

message ProductGpidResp {
	int64 gpid = 1;
}

// ---------------------------------------------------------------------------

message ProductGet {
	// 任填一个, 都提供时以第一个为准
	int64 gpid = 1;
	string refId = 2;
	string url = 5;

	// 需要类目面包屑
	bool needCrumbs = 6;
    bool isBuyforme = 7;

	// 必选
	string catalog = 3;
	string lang = 4; // en,zh,th,id,ms
}

message ProductDcatCrumbs {
	int32 dcid = 1;
	string dcname = 2;
}

message ProductGetResp {
	ProductEntity entity = 1;
	string unavailableReason = 3;

	repeated ProductDcatCrumbs crumbs = 2;
}

message ProductMultiGet {
	repeated int64 gpid = 1;
	repeated string refId = 2;

	// 必选
	string catalog = 3;
  string lang = 4; // en,zh,th,id,ms

  	// 需要类目面包屑
	bool needCrumbs = 6;
}

message ProductMultiGetResp {
	repeated ProductEntityOptional entity = 1;
}

// ---------------------------------------------------------------------------

message ProductSync {
	int64 gpid = 1;
	// 当使用refId时, 需要指定source
	string refId = 2;
	ProductSource source = 3;

	bool force = 4;
}

message ProductSyncResp {
	int64 gpid = 1;
}

// ---------------------------------------------------------------------------

message ProductSearch {
	string query = 1;
	int32 from = 2;
	int32 size = 3;
	repeated string sort = 4;
	bool nocache = 6;
	string cacheTime = 5;

	string catalog = 7;
	string lang = 8;
}

message ProductSearchResp {
	int64 total = 1;
	repeated ProductEntity entity = 2;
}


// ---------------------------------------------------------------------------

message ProductUpdate {
	ProductId id = 1;
	string fetchUrl = 5;
  bool fetchNotRealtime = 110;
	// 只能提供gpid的时候, 可以直接要求重新获取
	bool refetch = 109;

	bool upsert = 2;
	// 更新人(userName)
	string updateBy = 3;
	// 返回修改后的结果
	bool fetchResult = 4;
	bool forceSync = 6;

	// 自动获取操作会在修改 primeShipmentType/ezbuyShipmentType 之前
	// 如果原先已有值, 则只会做降级操作
	bool shipmentTypeAuto = 100;
	bool AutoPrime = 107; // 是否自动设置为prime
	// 运输方式更新只能降级不能升级, 用于通用的cid赋值等操作
	bool shipmentTypeDowngradeOnly = 105;
	// 运输方式只升级, 比如 普通空运会将敏感提升到普通属性
	// 不会因为某次敏感购买而降级, 不过升级会进入Review库
	bool sensitiveUpgradeOnly = 106;
	// 只有在ezbuy或者prime时才会更新成功
	bool onlyEzbuyPrime = 102;

	bool disableSyncLang = 103;
	bool disableSetUpdateTime = 104;
	bool updateRefId = 108;
	// --------------------------------------------
	// 属性更新
	// --------------------------------------------
	repeated double price = 10;
	repeated double originPrice = 11;
	repeated double weight = 12;
	repeated int32 ezbuyShipmentType = 13;
	repeated bool isEzbuy = 47;
	repeated bool isPrime = 14;
	repeated bool isOnSale = 15;
	repeated string name = 16;
	repeated string url = 17;
	repeated string vendorName = 18;
	repeated string brandName = 19;
	repeated int64 cid = 20;
	repeated string productImage = 21;
	repeated string stateCode = 22;
	repeated string sellType = 23;
	repeated string originCode = 24;
	repeated string localSales = 25;
	repeated string saleRegion = 26;
	repeated string originCountry = 27;
	repeated int32 primeShipmentType = 28;
	repeated bool isBoost = 29;
	repeated string descriptionImages = 30;
	repeated string descriptionText = 31;
	repeated string howToUse = 32;
	repeated int64 ezcid = 33;
	repeated string sellerId = 34;
	repeated common.Strings skuPropertyImages = 35;
	repeated string internalProductUrl = 36;
	repeated common.Time purchaseDate = 46;
	// 国内运费
	repeated double internalShipmentFee = 37;
	repeated int32 buyCount = 38;
	map<string, common.Strings> altNames = 39;
	repeated bool isSeller = 40; // ??
	map<string, common.Bools> isBlock = 42;
	map<string, common.Bools> isBlockDetail = 43;
	repeated bool isManuallyFetchFee = 44;
	map<string, common.Doubles> internalShipmentFees = 45;

	// TrendingShow
	repeated bool isPriceZone = 50;

	// prime estweight
	repeated double primeWeight = 51;

	repeated bool isPremium = 52;

	// ----------------------------------
	// 业务相关
	// ----------------------------------
	ProductUpdateCashOff Cashoff = 201;
  ProductUpdateFreeShipping FreeShipping = 202;

  // 贵重物品
  repeated bool isValueable = 203;
  // fragile
  repeated bool isFragile = 204;
  // 易分开发货
  repeated bool isSplitable = 205;
}

message ProductUpdateCashOff {
	repeated int64 start = 1;
	repeated int64 end = 2;
	repeated string catalog = 3;
	repeated string key = 4;
	repeated bool isCashOff = 5;
}

message ProductUpdateFreeShipping {
	repeated bool isFreeShipping = 1;
	repeated FreeShippingType type = 2;
}

message ProductUpdateResp {
	bool updated = 1;
	bool isNew = 3;
	ProductSimpleItem result = 2;
	string reason = 4;
}

// ---------------------------------------------------------------------------

message ProductSetOnSale {
	ProductId id = 1;
	bool isOnSale = 2;
}

// ---------------------------------------------------------------------------

message ProductSyncToes {
	ProductId id = 1;
}


// ---------------------------------------------------------------------------

message ProductSimpleNew {
	 ProductNew product = 1;
}

message ProductSimpleNewResp {

}

// ---------------------------------------------------------------------------

message ProductSimpleInfo {
	//gpid refId any one if you want
	string refId = 1;
	bool noSource = 2;

	ProductId productId = 3;
}

message ProductSimpleInfoResp {
	ProductSimpleItem result = 1;
	bool isExist = 2;
}


message ProductSimpleInfoMulti {
	repeated ProductId productId = 1;
}

message ProductSimpleInfoMultiResp {
	repeated ProductSimpleItem results = 1;
}

message ProductSimpleItem {
	int64 gpid = 4;
	string refId = 1;
	string url = 2;
	map<string, string> altNames = 3;
	string originCode = 10;
	string vendorName = 11;
	double weight = 12;
	int32 ezbuyShipmentType = 13; // ShipmentInfo
	double price = 14;
	double originPrice = 15;
	bool isEzbuy = 16;
	string name = 17;
	string altName = 18; // EnName
	map<string, bool> isBlock = 19;
	map<string, bool> isBlockDetail = 20;
	string productImage = 21;
	string internalProductUrl = 22;
	repeated string sellType = 23;
	bool isOnSale = 24;
	string brandName = 25;
	int64 cid = 26;
	int64 buyCount = 27;
	double internalShipmentFee = 28;
	string stateCode = 29;
	bool isPrime = 30;
	bool isTranslated = 31;
	bool isSeller = 32;
	int64 syncDate = 33;
	string sellerId = 34;
	int32 primeShipmentType = 35; // PrimeShippingType
	repeated string descriptionImages = 36;
	string descriptionText = 37;
	bool isBoost = 38;
	string availableShipmentTypeIds = 39;
	string domesticShippingEta = 40;
	string originCountry = 41;
	string howToUse = 42;
	map<string, double> internalShipmentFees = 43; // internalShippingFees
	string localSales = 44;
	repeated common.Strings skuPropertyImages = 45;
	bool isManuallyFetchFee = 46;
	int32 pcid = 47;
	string blockHit = 48;
    ProductUpdateFreeShipping freeShipping = 49;
	repeated int32 descPropertyValueIds = 50;
	bool isPremium = 51;
}

// ---------------------------------------------------------------------------

message ProductSku {
	ProductId id = 1;
	string skuId = 4;
}

message ProductSkuResp {
	repeated ProductSkuItem results = 1;
}

message ProductSkuItem {
	string skuId = 1;
	string refId = 2;
	int32 quantity = 3;
	string name = 4;
	double weight = 5;
	int64 gpid = 6;
	map<string, string> props = 7;
}

message ProductSkuWeight {
	ProductId id = 1;
	string skuId = 2;
}

message ProductSkuWeightResp {
	double weight = 1;
}

message ProductSkuAllWeightItem {
	string skuId = 1;
	double estWeight = 2;
	double weight = 3;
	int32 quantity = 4;
	string name = 5;
	map<string, string> props = 6;
}

message ProductAllSkuWeightResp {
	repeated ProductSkuAllWeightItem skus = 1;
}

// ---------------------------------------------------------------------------

message ProductSellerSimple {
	ProductId id = 1;
}

message ProductSellerSimpleResp {
	ProductSellerSimpleItem items = 1;
}

message ProductSellerSimpleItem {
	string refId = 1;
	int32 sellType = 2;
}

// ---------------------------------------------------------------------------

message ProductBlockVendor {
	string vendorName = 1;
	bool isBlock = 2;
}

message ProductBlockVendorResp {
	bool updated = 1;
}

message ProductGetBlockVendor {}

message ProductGetBlockVendorResp {
	repeated string vendorName = 1;
}

// ---------------------------------------------------------------------------

message ProductChangeLog {
	int64 gpid = 1;
	string refId = 2;
}

message ProductChangeLogResp {
	repeated ProductChangeLogItem changed = 2;
}

message ProductChangeLogItem {
	string date = 1;
	string updateBy = 2;
	map<string, string> changed = 3;
}

// ---------------------------------------------------------------------------

// 参数只能任选一个填
message ProductGetGpid {
	string refId = 1;
	string url = 2;

	repeated string multiRefIds = 3;
	repeated string multiUrls = 4;
}

message ProductGetGpidResp {
	bool singleIsNotfound = 1;
	int64 singleGpid = 2;
	// 如果没有找到, 则返回空
	repeated int64 multiGpids = 3;
}

// ---------------------------------------------------------------------------

message ProductSubscribe {
	bool all = 1;
	repeated int64 addGpid = 2;
	repeated int64 delGpid = 3;
	common.Time start = 4;
}

message ProductSubscribeItem {
	string itemId = 1;
	int64 gpid = 2;
	bool isOnSale = 3;
	double price = 4;
	common.Time updateDate = 5;
}

message ProductSubscribeResp {
	repeated ProductSubscribeItem updates = 1;
}

// ---------------------------------------------------------------------------

message ProductSkuSetWeight {
	ProductId id = 1;
	double weight = 2;
	// map[skuId]ProductSkuWeightItem
	map<string, ProductSkuWeightItem> items = 3;
  string updateBy = 4;
  bool noSyncSpk = 5;
}

message ProductSkuWeightItem {
	int64 qty = 2;
}

message ProductSkuSetWeightResp {
	bool updated = 1;
}

message ProductSkuWeightUpdate {
	ProductId id = 1;
	repeated ProductSkuAllWeightItem skus = 2;
}

message ProductSkuWeightUpdateResp {
	bool updated = 1;
}

// ---------------------------------------------------------------------------

message ProductMeta {
	int64 gpid = 1;
	string refId = 2;
	string url = 3;
}

message ProductMetaResp {
	int64 gpid = 1;
	string refId = 2;
}

// ---------------------------------------------------------------------------
enum ProductReviewAction {
	ProductReviewActionInvalid = 0;
	ProductReviewActionSensitive = 1;
}

// ---------------------------------------------------------------------------

message ProductTaobao {
	string url = 1;
}

message ProductTaobaoResp {
	string url = 1;
	string refId = 2;
	string pictureUrl = 3;
	string title = 4;
}


message ProductRandomTaoBaoItems {
}

message ProductTaoBaoItem {
	string name = 1;
	string productImage = 2;
	string url = 3;
	double price = 4;
}

message ProductRandomTaoBaoItemsResp {
	repeated ProductTaoBaoItem items =1;
}

message EzDCategoryTree {
	int32 cid = 1;
	string lang = 2;
	string catalog = 3;
	EzDCategoryTreeOption option = 4;
}

message EzDCategoryTreeOption {
	bool NeedCount = 1;
	bool PrimeOnly = 2;
	bool CashOffOnly = 3;
	bool FreeShippingOnly = 4;
	FreeShippingType FreeShippingType = 5;
}

// ---------------------------------------------------------------------------

message TCidWeight {
	int64 tcid = 1;
	double weight = 2;
}

message UpdateTCidWeightResp {
	bool updated = 1;
}

// ---------------------------------------------------------------------------

message ProductTempUpdateSellerSkuItem {
	string id = 1;
	string name = 2;
	repeated string images = 3;
	bool isOnSale = 4;
	double weight = 5;
	double price = 6;
	double originPrice = 7;
	int32 quantity = 8;
	map<string, string> attributes = 9;
}

message ProductTempUpdateSellerSku {
	string refId = 1;
	string sellerId = 2;
	repeated ProductTempUpdateSellerSkuItem sku = 3;
}

message ProductTempUpdateSellerSkuResp {
	int32 udpated = 1;
	int32 inserted = 2;
	int32 removed = 3;
}

// ---------------------------------------------------------------------------

message ProductWalk {
  string selector = 1;
  string cursor = 2;
  bool isAllProduct = 3;
}

message ProductWalkResp {
  string cursor = 2;
  repeated ProductWalkItem item = 1;
}

message ProductWalkItem {
  int32 pcid = 1;
  int64 cid = 2;
  string url = 3;
  int64 gpid = 4;
  string name = 5;
  double weight = 6;
}
