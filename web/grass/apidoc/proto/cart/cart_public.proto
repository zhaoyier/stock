syntax = "proto3";
package cart;

option swift_prefix = "GR";

import "common/ezbuy.proto";
import "appcommon/common_public.proto";

service CartPublic {
  option (common.service).webapi = true;
  // 添加购物车
  rpc Add(CartPublicAdd) returns (CartResult) {
	option (common.timeout) = "1s";
  }

  // 添加用户定制化商品，buyforme
  rpc AddCustomize(CartPublicAddCustomize) returns (CartResult) {
	option (common.timeout) = "1s";
  };

  // 修改购物车
  // modifyItems ===> 修改购物车信息
  rpc Modify(CartPublicModify) returns (CartResult) {
	option (common.timeout) = "1s";
  };

  // 修改用户定制化商品 buyforme
  rpc ModifyCustomize(CartPublicModifyCustomize) returns (CartResult) {
	option (common.timeout) = "1s";
  };

  // 修改购物车商品数量
  rpc ModifyQty(CartPublicModifyQty) returns (CartResult) {
	option (common.timeout) = "1s";
  };

  // 删除购物车
  // cartIds
  rpc Delete(CartPublicDelete) returns (CartResult) {
	option (common.timeout) = "1s";
  };

  // 获取购物车
  rpc Get(CartPublicGet) returns (CartPublicGetResp) {
	option (common.timeout) = "1s";
  };

  // 下单 ------------------------------------------------------------------

  // 获取用户的checkout信息
  rpc GetCheckoutInfo(CartPublicGetCheckoutInfo) returns (CartPublicGetCheckoutInfoResp);

  // 用户修改checkout信息，并获取对应的账单信息
  rpc ModifyCheckoutBill(CartPublicModifyCheckoutBill) returns (CartPublicModifyCheckoutBillResp);

  // 获取针对账单可用的优惠券
  rpc GetCheckoutVoucher(CartPublicGetCheckoutVoucher) returns (CartPublicGetCheckoutVoucherResp);

  // 用户进行checkout操作
  rpc MakeCheckout(CartPublicMakeCheckout) returns (CartPublicMakeCheckoutResp){
  option (common.timeout) = "30s";
  };
}

// ---------------------------------------------------------------------------

// 添加购物车req
message CartPublicAdd {
  // 商品gpid
  int64 gpid = 1;
  // 如果没有skuId，可给默认值0
  int64 skuId = 2;
  // 商品访问时的链接
  string url = 3;
  // 所有服务类型必填
  int32 qty = 4;
  // 所有服务类型必填
  ServiceType serviceType = 5;
  // 选填，用户备注
  string remark = 6;
  // 选填，商品加购来源入口
  string purchaseSource = 7;
}

message CartPublicAddResp {
  bool successed = 1;
  string msg = 2;
  int64 code = 3;
  string cartId = 4;
}

// ---------------------------------------------------------------------------

message CartPublicAddCustomize {
  // 商品名
  string productName = 1;
  // 卖家名
  string vendorName = 2;
  // 商品来源地
  string region = 3;
  // 如果没有skuId，可给默认值0
  int64 skuId = 4;
  // 用户填入的链接
  string url = 5;
  // 用户填写的buyforme来源地价格
  double unitPrice = 6;
  // 国内运费
  double internalExpressFee = 7;
  // 所有服务类型必填
  int32 qty= 8;
  // 默认是buyforme
  ServiceType serviceType = 9;
  // 选填，用户备注
  string remark = 10;
  // 选填，商品加购来源入口
  string purchaseSource = 11;
}

message CartPublicAddCustomizeResp {
  bool successed = 1;
  string msg = 2;
  int64 code = 3;
  string cartId = 4;
}

// ---------------------------------------------------------------------------

message CartPublicModify {
  repeated CartPublicModifyItem modifyItems = 1;
}

message CartPublicModifyItem {
  // 需要编辑的购物车id
  string cartId = 1;
  // 修改后数量，比如原来是3，增加1，则传入4
  int32 qty = 2;
  // 新的skuId，如果不修改，则默认为原值
  int64 newSkuId = 3;
  // 更新用户商品备注
  string remark = 4;
}

message CartPublicModifyResp {

}

// ---------------------------------------------------------------------------

message CartPublicModifyCustomize {
  repeated CartPublicModifyCustomizeItem modifyCustomizeItems = 1;
}

// ---------------------------------------------------------------------------

message CartPublicModifyCustomizeItem {
  // 需要编辑的购物车id
  string cartId = 1;
  // 修改后数量，比如原来是3，增加1，则传入4
  int32 qty = 2;
  // 新的skuId，如果不修改，则默认为原值
  int64 newSkuId = 3;
  // 商品名
  string productName = 4;
  // 卖家名
  string vendorName = 5;
  // 用户填入的链接
  string url = 6;
  // 用户填写的buyforme来源地价格
  double unitPrice = 7;
  // 国内运费
  double internalExpressFee = 8;
  // 选填，用户备注
  string remark = 9;
}

message CartPublicModifyCustomizeResp {

}

// ---------------------------------------------------------------------------

message CartPublicModifyQty {
  repeated CartPublicModifyQtyItem modifyCartQtyItems = 1;
}

message CartPublicModifyQtyItem {
  string cartId = 1;
  int32 qty = 2;
}

message CartPublicModifyQtyResp {
}

// ---------------------------------------------------------------------------

message CartPublicDelete {
  repeated string cartIds = 1;
}

message CartPublicDeleteResp {

}

// ---------------------------------------------------------------------------

message CartPublicGet {
  // cartType ===> 1: prime cart ; 2: not prime
  int32 cartType = 1;
}

message CartPublicGetResp {
  CartResult result = 2;
  CartPublicGetInfo cartSummaryInfo = 1;
  CartViewExt cartViewExt = 3; // 购物车视图方面相关信息
}

message CartPublicGetInfo {
  repeated PublicCartItem cartItems = 1;
}

// ---------------------------------------------------------------------------

message PublicCartItem {
    string vendorName = 1; // 卖家名
    string region = 2; // 卖家所在区域
    repeated PublicCartProductInfo products = 3; // 商品列表
}

message PublicCartProductInfo {
  //购物车商品项id
  string cartId = 1;
  //商品单价
  double price = 2;
  //商品来源地单价
  double regionPrice = 3;
  //商品名称
  string productName = 4;
  //商品url
  string url = 5;
  //商品图片
  string productImage = 6;
  //数量
  int32 qty = 7;
  //sku名称
  string skuName = 8;
  //商品的额外信息
  TCartProductExtraInfo extraInfo = 9;
  //用户商品备注
  string remark = 10;
  //国内运费
  double internalExpressFee = 11;
  //国际运费
  double shippingFee = 12;
  int64 	gpid = 13;
  //商品类型
  ServiceType serviceType = 14;
  //skuId
  int64 skuId = 15;
  //商品原始名称，用于GA
  string originalProductName = 16;
}

message TCartProductExtraInfo {
  //[1 == BuyForMe
  // 2 == CashOff
  // 3 == Gst,
  // 4 == isSensitive 是否显示敏感标签文案,
  // 5 == isFreeShipping 是否包邮活动,
  // 6 == isOffSale 是否下架,
  // 7 == isShowStock 是否展示库存,
  // 8 == isMnCut 是否满件减]
  repeated int32 tags = 1;
  //新币gst
  double gst = 2;
  //美国手续费
  double handlingFee = 3;
  //美国手续费比例
  double specialHandlingFeePercent = 4;
  //合作卖家国际运费折扣
  string sellerDiscount = 5;
  //满减折扣的文案
  string cashOffDiscount = 6;
  //满减折扣的key
  string cashOffKey = 7;
  //剩余库存
  int32 stockLeft = 8;
  //标签文案
  string tagMsg = 9;
  // 购物车视图标签信息
  repeated CartViewExt cartViewExts = 10;
}

// ---------------------------------------------------------------------------

message CartPublicGetCheckoutInfo {
  // cartIds 用户选中的购物车id
  repeated string cartIds = 1;
  // serviceType
  ServiceType serviceType = 2;
  // 闪购商品信息
  TFlashsalesProduct flashsalesProduct = 3;
  // 特殊版本
  Version version = 4;
}

message CartPublicGetCheckoutInfoResp {
  // 通用返回消息
  CartResult result = 1;
  // checkout信息
  TCheckoutInfo info = 2;
}

message TCheckoutInfo {
  // 服务类型
  ServiceType serviceType = 1;
  // 前端显示元素控制
  TElementInfo elementInfo = 2;
  // 商品来源相关信息
  repeated TRegionInfo regionInfos = 3;
  TDeliveryAddress deliveryAddress = 4;
  // 闪购商品信息
	TFlashsalesProduct flashsalesProduct = 5;


	// ===================
	// * 是否可以分组派送判断规则 获取账单后 deliveryGroups 长度大于1
	// * 合并/分组派送 商品显示所有国家按照  deliveryGroups 显示
	// ===================

  // 03.15 拆分子订单版本
  // 这个版本之后的代码，不再使用上面定义的【deliveryAddress】
  // 按派送分组
  repeated TDeliveryGroup deliveryGroups = 7;

  // 用户选择的派送组类别
  DeliveryGroupType deliveryGroupType = 8;
}

// 按派送分组
message TDeliveryGroup {
  string groupKey = 1;
  repeated string cartIds = 2;

  double subWeight = 8; // 重量小计
  string eta = 11; // 组内eta
  TDeliveryAddress deliveryInfo = 12;
}

message TFlashsalesProduct {
  int64 gpid = 1;
  string skuId = 2;
  string url = 3;
  int32 qty = 4;
  string remark = 5;
  string region = 6;
  string settingId = 7;
}

// 采购地区信息
message TRegionInfo {
  // 采购来源地区
  string region = 1;
  // 运输方式
  repeated TCartShippingMethod shippings = 2;
  // 仓库信息
  repeated TCartWarehouseAddress warehouses = 3;
  // 该地区所有商品重量
  double weight = 4;
  // 购物车id
  repeated string cartIds = 5;
  // 用户已经选择的 shipping
  TCartShippingMethod shipping = 6;
  // 用户已经选择的 warehouse
  TCartWarehouseAddress warehouse = 7;
  // elementInfo中的isMultiDelivery 为true时，使用该数据源，否则使用TCheckoutInfo的TDeliveryAddress
  TDeliveryAddress deliveryAddress = 8;
  // 分组唯一Id
  int32 groupId = 9;
}

message TCartShippingMethod {
  string code = 1;
  // buy4me中，如所有商品shipping method都有选择，
  // 但是不是完全相同的情况下，shippingMethodName为“Multiple”，
  // available为true；如有商品没有选择shipping method，
  // shippingMethodName为“2 Unselected”
  // （2替换为没有选择shipping method的商品数量），available为false
  string name = 2;
  string desc = 3;
  double cost = 4;
  bool available = 5;
  // 最晚到达日期，timestamp from 1970，缺省或者为负数表示没有eta
  int64 latestETA = 6;

  // id标记
  int32 shippingId = 7;
}

// TODO 找时间清理该结构体
message TDeliveryAddress {
  int32 addressID = 1;
  string deliveryMethodCode = 2;
  string deliveryMethodName = 3;
  // 根配送方式的Code，如Home，Warehouse等
  string deliveryTypeCode = 4;
  string address = 5;
  string recipient = 6;
  string phone = 7;
  repeated TDeliveryMethodExtension deliveryMethodExtensions = 8;
  // 重量限制
  double maxWeight = 9;
  //时间段Id和名字
  appcommon.TCommonOptionItemWithId pickupPeriod = 10;
  string state = 12; // express服务传递使用，客户端不需要处理
}

//选择派送方式的扩展
message TDeliveryMethodExtension{
  //扩展的控件类型，目前只有麦当劳有用到
  // 需要输入车牌信息，是个输入框。其默认值为：input
  string type = 1;
  //显示名称
  string name = 2;
  //名称对应的值
  string value = 3;
}

message TCartWarehouseAddress {
  string code = 1;
  string name = 2;
  bool available = 3;

  // id标记
  int32 warehouseId = 4;
}

// ---------------------------------------------------------------------------

// 获取用户checkout账单请求值
message CartPublicModifyCheckoutBill {
  TCheckoutInfo checkoutInfo = 1;
}

// 获取用户checkout账单返回值
message CartPublicModifyCheckoutBillResp {
  // 通用返回消息
  CartResult result = 1;
  // 总额
  double totalFee = 2;
  // 账单信息
  repeated TBillDetail billDetails = 3;
  // checkout信息
  TCheckoutInfo info = 4;
  // 预付款余额
  double prepay = 5;
}

// 账单明细项目
message TBillDetail {
  //账单名称
  string billCategoryName = 1;
  //费用
  double total = 2;
}

// 获取针对账单可用的优惠券请求值
message CartPublicGetCheckoutVoucher {
  TCheckoutInfo checkoutInfo = 1;
}

message CartPublicGetCheckoutVoucherResp {
  // 优惠券分组信息
  repeated TCheckoutVoucherGroup voucherGroups = 1;
  CartResult result = 2;
}

message TCheckoutVoucherGroup {
  // 组名
  string name = 1;
  // 优惠券
  repeated TCheckoutVoucher vouchers = 2;
}


// 优惠券
message TCheckoutVoucher {
  // 业务内标识
  string code = 1;
  // 是否可选（基于当前选择）
  bool available = 2;
  // 是否过期
  bool expired = 3;
  // 名称
  string name = 4;
  // 描述
  string desc = 5;
  // 图片地址
  string pic = 6;
}

// ---------------------------------------------------------------------------

// 用户进行checkout操作请求值
message CartPublicMakeCheckout {
  // 是否延迟付款
  bool isDeferPay = 1;
  // checkout信息
  TCheckoutInfo info = 2;
}

// 用户进行checkout操作返回值 （再议）
message CartPublicMakeCheckoutResp {
  CartResult result = 1;
  int32 shipmentId = 2;
  bool isPayed = 3;
  string paymentNo = 4;
  string submitMsg = 5;
  string transactionId = 6;
  double topupAmout = 7; // !!!!!! TODO: 检查这里
  string paymentIds = 8;
  string friendsDealGroupId = 9;
  bool isCreditCardOnly = 10;
  TPaymentResp paymentRespForWeb = 11;
  int64 orderId = 12;
  int64 billId = 13;
  string BillSrcType = 14;
}

message TPaymentResp {
  // 加密后的付款号 多个用逗号隔开
  string encryptPaymentId = 1;
  // 加密后的订单号 多个用逗号隔开
  string encryptPaymentNos = 2;
  // 加密后的shipmentId 多个逗号隔开
  string encryptShipmentId = 3;
  // 加密后的包裹Id 多个逗号隔开
  string encryptPackageId = 4;
}

enum ServiceType {
  ServiceTypeInvalid = 0;
  ServiceTypeB4m = 1;
  ServiceTypeEzbuy = 3;
  ServiceTypePrime = 4;
}

message CartResult {
  bool succeeded = 1;
  string msg = 2;
  int64 code = 3;
  string cartId = 4;
}

// 提供给客户端的控制信息
message TElementInfo {
  // 是否使用保险
  bool insured = 1;
  // 是否显示保险
  bool insuredEnabled = 2;
  // 使用积分数
  int32 credit = 3;
  // 是否显示积分
  bool creditEnabled = 4;
  // 使用voucher列表
  repeated string voucherIds = 5;
  // 是否显示voucher
  bool voucherEnabled = 6;
  // 使用coupon
  string coupon = 7;
  // 是否显示coupon
  bool couponEnabled = 8;
  // 是否显示仓库
  bool warehouseRequired = 9;
  // 是否显示运输方式
  bool shippingMethodRequired = 10;
  // 是否显示派送方式
  bool deliveryMethodRequired = 11;
  // 是否授权差额补齐
  bool isAuthorizeBalance = 12;
  // 是否显示差额补齐
  bool authorizeForBalanceRequired = 13;
  // 可选的优惠券数量
  int32 validVoucherCount = 14;
  // 是否多地址选择
  bool isMultiDelivery = 15;
  // 顶端模块文案
  string topMessage = 16;
  // 派送模块文案
  string deliveryMessage = 17;
}

// 购物车视图方面相关信息
message CartViewExt {
    CartViewTag cartViewTag = 1; // 可用于定义标签所在视图中的位置，用来给前端标记该内容的唯一位置，以位置来决定标签的展示，而不是内容决定位置
    string title = 2; // 提供标题
    repeated string titleParams = 3; // title中的参数
    string link = 4; // 提供可配置的链接参数
}

// 购物车外层视图标签枚举   用来给前端标记该内容的唯一位置，以位置来决定标签的展示，而不是内容决定位置
enum CartViewTag {
    Default = 0;
    PrimeMemberPush = 1; // 在购物车最外层显示prime member push

    ActDefault = 100; // 普通活动，活动默认位置
    ActDiscount = 101; // 折扣
    ActCashOff = 102; // 满减
    ActFreeShipping = 103; // 包邮
    ActMnCutoff = 104; // 满件减
}

enum Version {
    DefaultVersion = 0;
    OrderStage4 = 1;
    SplitDelivery = 2; // 201709
}

// 派送组类别
enum DeliveryGroupType {
  DeliveryGroupTypeDefault = 0; // 什么都没有选。。。
  DeliveryGroupTypeOneHome = 1; // 送货上门
  DeliveryGroupTypeOneStation = 2; // 自取
  DeliveryGroupTypeCustomize = 3; // 自定义
}
