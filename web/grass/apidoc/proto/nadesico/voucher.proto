syntax = "proto3";
package nadesico;

import "common/ezbuy.proto";
import "common/empty.proto";
import "common/html.proto";
import "appcommon/common_public.proto";

service Voucher {
	rpc Ping(PingReq) returns (Resp);

	//! 创建券
	rpc Create(CreateVoucherReq) returns (Resp);

	//! 服务端给券
	rpc Give(GiveVoucherReq) returns (Resp);
	
	//! 服务端批量给券
	rpc MultiGiveByLoadIn(MultiGiveVoucherReq) returns (MultiGiveVoucherResp){
		option (common.timeout) = "60s";
	}

	//! 批量用券：强制用券，一定可以成功
	rpc MultiUse(MultiUseVoucherReq) returns (Resp){
        option (common.webapi).enable = false;
	};
	
	//! 批量券冲正
	rpc MultiUnUse(MultiUnUseVoucherReq) returns (Resp){
        option (common.webapi).enable = false;
	};

	//! voucherAdmin 查询单个券活动
	rpc GetVoucherType(GetVoucherTypeReq) returns (GetVoucherTypeResp);

	//! voucherAdmin 补发券：额外增加券数量
	rpc IncreaseVoucher(IncreaseVoucherReq) returns (Resp);

	//! voucherAdmin 延长有效期
	rpc UpdateEndDate(UpdateEndDateReq) returns (Resp);

	//! voucherAdmin 批量查询券活动
	rpc GetMultiVoucherTypeForServer(GetMultiVoucherTypeReq) returns (GetMultiVoucherTypeResp);

	//! voucherAdmin 查询券使用情况
	rpc GetVoucherTypeUsage(GetVoucherTypeUsageReq) returns (GetVoucherTypeUsageResp);

	//! 删除缓存里的voucher信息，下次刷新时，可以获取最新券信息
	rpc DecacheRedisUserVoucher(GetVoucherTypeReq) returns (Resp);

	//! 更新voucher ruleId
	rpc UpdateRuleId(UpdateRuleIdReq) returns (Resp);

	//! 查询国家运输方式
	rpc GetShipments(GetShipmentsReq) returns (GetShipmentsResp);

	// ================== 用户接口 ==================

	//! spike 用户查询券活动2: 由满减专区确定voucherTypeId，直接查询用户中心相关信息（部分券信息还未同步过来)
	rpc GetUserMultiSimpleVoucherType(GetUserMultiSimpleVoucherTypeReq) returns (GetMultiSimpleVoucherTypeResp);

	//! 用户主动领券
	rpc Receive(ReceiveVoucherReq) returns (Resp);

	//! 用户查询某状态的券
	rpc GetMultiVoucher(GetMultiVoucherReq) returns (GetMultiVoucherResp);

	//! 用户查询某状态的券
	rpc UserGetMyVouchers(UserGetMyVouchersReq) returns (UserGetMyVouchersResp);

	//! 用户查询有效券个数
	rpc UserGetAvailableVoucherCount(UserGetAvailableVoucherCountReq) returns (UserGetAvailableVoucherCountResp);

	rpc UserHasAvailablePrimeVoucher(UserHasAvailablePrimeVoucherReq) returns (UserHasAvailablePrimeVoucherResp);

	// ================== 活动中心接口 ==================

	//! 活动中心绑定券，先要查询券信息, 不需要给出已经领取券数和已经使用券数
	rpc GetMultiSimpleVoucherType(GetMultiSimpleVoucherTypeReq) returns (GetMultiSimpleVoucherTypeResp);

	//! 活动中心查询
	rpc GetRulesVoucherTypeIds(GetRulesVoucherTypeIdsReq) returns (GetRulesVoucherTypeIdsResp);

	//! 根据voucherTypeId查询ruleId
	rpc GetRuleIdsByVoucherTypeIds(GetRuleIdsByVoucherTypeIdsReq) returns (GetRuleIdsByVoucherTypeIdsResp);

	//! 查询用户单张券信息
	rpc ReportVoucher(common.Empty) returns (common.Html);

	// 查询用户的券
	rpc ReportUserVouchers(common.Empty) returns (common.Html);

	// 查询券信息
	rpc ReportVoucherType(common.Empty) returns (common.Html);
}

// ---------------------------------------------------------------------------

//！ ping service
message PingReq {
    string msg = 1;
}

//! 通用响应
message Resp {
    int32 code = 1; //errcode
    string message = 2; //errmsg
}

message GetShipmentsReq{
	string catalogCode = 1; // 券所属国家或地区
	int32 region = 2; // 商品来源地所属国家或地区, 目前仅支持单选
}

message GetShipmentsResp{
	repeated Shipments shipments = 1;
}

message Shipments{
	string shipmentTypeCode = 1;
	string shipmentTypeName = 2;
}

message CreateVoucherReq {
	string name = 1;
	string ruleId = 2;
	int32 totalCount = 3;
	int32 countPerCustomer = 4;
	string catalogCode = 5;
	string img = 6;
	string description = 7;
	string pictureColor = 8;
	// 券类型
	VoucherCategory voucherCategory = 9;
	int64 startDate = 10;
	int64 endDate = 11;
	bool isServerSend = 12;
	int32 duration = 13;
	int32 serviceType = 16;
	int32 firstAmount = 17;
	int32 secondAmount = 18;
	int32 region = 19;
	string shipmentTypeCodes = 20;
}

message AdminUpdateEndDateReq {
	int64 customerId = 1;
	int64 voucherId = 2;
	int64 endDate = 3; // 时间戳
}

message UpdateRuleIdReq {
	repeated int64 voucherTypeIds = 1;
}

message GetVoucherTypeReq {
	int64 voucherTypeId = 1;
}

message GetVoucherTypeResp {
	VoucherType voucherType = 1;
	int32 code = 101; //errcode
	string message = 102; //errmsg
}

message VoucherType {
	 int64 id = 14;
	 string name = 1;
	 string ruleId = 2;
	 int32 totalCount = 3;
	 int32 countPerCustomer = 4;
	 string catalogCode = 5;
	 string img = 6;
	 string description = 7;
	 string pictureColor = 8;
	 VoucherCategory voucherCategory = 9;// 券类型
	 int64 startDate = 10;
	 int64 endDate = 11;
	 int32 receivedCount = 12;// 用户已经领券数量
	 bool canReceive = 13;// 是否可以再领
	 int32 remainCount = 15;
	 int32 serviceType = 16;
	 int32 firstAmount = 17;
	 int32 secondAmount = 18;
	 int32 usedCount = 19;
	 bool isServerSend = 20;
	 int32 duration = 21;
	 string url = 22;
	 int32 region = 23;
	 int64 createDate = 24;
	 string shipmentTypeCodes = 25;
	 string shipmentTypeNames = 26;
}

message IncreaseVoucherReq {
	int64 voucherTypeId = 1;
	int32 delta = 2;
}

message UpdateEndDateReq {
	int64 voucherTypeId = 1;
	int64 endDate = 2;
}

message GetMultiVoucherTypeReq {
	VoucherCategory voucherCategory = 1;
	string catalogCode = 2; // 服务端调用接口时，必传
	int32 offset = 3;
	int32 limit = 4;
	bool isRegisterVoucher = 5; // 天数 用来判断是否是注册红包券
}

message GetMultiVoucherTypeResp {
	repeated VoucherType voucherTypes = 1;
	int32 totalCount = 2;
	int32 code = 101; //errcode
	string message = 102; //errmsg
}

message GetUserMultiSimpleVoucherTypeReq {
	repeated int64 voucherTypeIds = 1;
	int64 customerId = 2;
}

message GetMultiSimpleVoucherTypeReq {
	repeated int64 voucherTypeIds = 1;
	string catalogCode = 2;
}

message GetMultiSimpleVoucherTypeResp {
	repeated VoucherType voucherTypes = 1;
	repeated int64 wrongCatalogVoucherTypeIds = 2; // 国家代码不符
	repeated int64 noInfoVoucherTypeIds = 3; // 没有查询到信息
	int32 code = 101; //errcode
	string message = 102; //errmsg
}

message GetRuleIdsByVoucherTypeIdsReq {
	repeated int64 voucherTypeIds = 1;
}

message GetRuleIdsByVoucherTypeIdsResp {
	repeated string ruleIds = 1;
	int32 code = 101; //errcode
	string message = 102; //errmsg
}

message GetRulesVoucherTypeIdsReq {
	string ruleId = 1;
}

message GetRulesVoucherTypeIdsResp {
	repeated int64 voucherTypeIds = 1;
	int32 code = 101; //errcode
	string message = 102; //errmsg
}

message MultiGiveVoucherResp {
	repeated int64 reachedLimitCustomerIds = 1;
	int32 code = 101; //errcode
	string message = 102; //errmsg
}

message GiveVoucherReq {
	int64 customerId = 1;
	int64 voucherTypeId = 2;
	ChannelId channelId = 3;
}

message MultiGiveVoucherReq {
	int64 voucherTypeId = 1;
	repeated int64 customerIds = 2;
}

message ReceiveVoucherReq {
	int64 voucherTypeId = 1;
	ChannelId channelId = 2;
}

message MultiUseVoucherReq {
	int64 customerId = 1;
	int64 orderId = 2;
	repeated int64 voucherIds = 3;
}

message MultiUnUseVoucherReq {
	int64 customerId = 1;
	int64 orderId = 2;
	repeated int64 voucherIds = 3;
}

message UseVoucherReq {
	int64 customerId = 1;
	int64 voucherId = 2;
	int32 voucherCategory = 3;
	int64 orderId = 4;
}

message UnuseVoucherReq {
	int64 customerId = 1;
	int64 voucherId = 2;
}

message GetMultiVoucherReq {
	VoucherStatus status = 1;
	int32 offset = 2;
	int32 limit = 3;
	int64 customerId = 4; // 订单系统必须传入 customerId
	string catalog = 5; // 订单系统必须传入 catalog
	ServiceType serviceType = 6; // 订单系统必须传入 serviceType
}

// 0: 满减券, 1: 红包券,注册现金劵 2: prime体验券, 3:agentFee券 4:shipping voucher
enum VoucherCategory {
	FullCut = 0; // 满减券
	Cash = 1; // 现金红包券（包括注册红包券）
	PrimeTrial = 2; // prime体验券
	AgentFee = 3; // agentFee券
	Shipping = 4; // 运费券
	AllCategory = 110;
}

// 购物车定义：invalid:0 b4m:1 ezbuy:3 prime:4
enum ServiceType {
	ServiceTypeAll = 0;
	ServiceTypeOther = 1;
	ServiceTypeBuy4Me = 2;
	ServiceTypeShip4Me = 4;
	ServiceTypeEzbuy = 8;
	ServiceTypePrime = 16;
}

enum VoucherStatus {
	VAll = 0;
	VUnUsed = 1; // Available
	VUsed = 2;
	VExpired = 3;
	VUnAvailable = 4; // 无效券，包括Expired 和 Used
	VUnknown = 5;
}

// 0:Other 1:slotMachine 2:champagne 3:newRegister 4:signIn 5:topUP 6:cashOff
enum ChannelId {
	Other = 0;
	SlotMachine = 1;
	Champagne = 2;
	NewRegister = 3;
	SignIn = 4;
	TopUP = 5;
	CashOff = 6;
	Tights = 7;
}

// 适用区域 0:所有 1:中国 2:美国 4:台湾 8:韩国
enum Area {
	AllArea = 0;
	China = 1;
	America = 2;
	Taiwan = 4;
	Korea = 8;
}

message UserVoucher {
	int64 id = 1;
	int64 voucherTypeId = 2;
	string ruleId = 4;
	string catalogCode = 5;
	string name = 6;
	string description = 7;
	string img = 8;
	string pictureColor = 9;
	int32 channelId = 10;
	VoucherStatus status = 11;
	int64 createDate = 12;
	int64 updateDate = 13;
	int64 startDate = 14;
	int64 endDate = 15;
	int32 voucherCategory = 16;
	int32 firstAmount = 17;
	int32 secondAmount = 18;
	string url = 19;
	int32 serviceType = 20;
	bool available = 21;
	int32 region = 22;
}

message GetMultiVoucherResp {
	int32 totalCount = 1;
	repeated UserVoucher vouchers = 2;
	int32 code = 101; //errcode
	string message = 102; //errmsg
}


message UserGetAvailableVoucherCountReq {
	int64 customerId = 1;
	string catalogCode = 2;
}

message UserGetAvailableVoucherCountResp {
	int32 availableCount = 1;
	int32 code = 101; //errcode
	string message = 102; //errmsg
}

message UserHasAvailablePrimeVoucherReq {
	int64 customerId = 1;
}

message UserHasAvailablePrimeVoucherResp {
	bool hasAvailablePrimeVoucher = 1;
	appcommon.ResultResp result = 2;
}

// 分页查询时，offset limit才起作用；默认查询第一页时，offset limit不要传参数
message UserGetMyVouchersReq {
	int32 status = 1; // 0: 所有状态, 1:可用券, 2:已经使用的券, 3:已经过期的券
	int32 voucherCategory = 2; // 券类型： 0 -> 满减券， 1 -> 红包券，2 -> prime体验券，3 -> agentFee券 4 -> 所有类型的券
	int32 offset = 3;
	int32 limit = 4; // 查询上面条件 limit条数据
}

message UserGetMyVouchersResp {
	repeated MyVouchersOfType result = 1;
	int32 code = 101; //errcode
	string message = 102; //errmsg
}

message MyVouchersOfType {
	string name = 1; // 券的类型：0 -> 满减券， 1 -> 红包券，2 -> prime体验券，3 -> agentFee券
	string displayName = 2; // 对应的券名称
	repeated UserVoucher vouchers = 3;
	int32 totalCount = 4;
}

message GetVoucherTypeUsageReq {
	int64 voucherTypeId = 1;
	int32 offset = 2;
	int32 limit = 3;
}

message GetVoucherTypeUsageResp {
	repeated VoucherUsage usages = 1;
	int32 totalCount = 2;
	int32 code = 101; //errcode
	string message = 102; //errmsg
}

message VoucherUsage {
	int64 voucherId = 1;
	int64 customerId = 2;
	int32 status = 3;
	int32 givenChanel = 4;
}