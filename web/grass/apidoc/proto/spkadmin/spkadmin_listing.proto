syntax = "proto3";
package spkadmin;
import "common/ezbuy.proto";
import "biz/region.proto";
import "spk/spk_public.proto";
import "common/setter.proto";
import "spkadmin/spkadmin_job.proto";
import "spk/spk_item_sync.proto";
import "spk/spk_xitem.proto";

service Listing {
  option (common.service).webapi = true;
  rpc ExportProducts(ListingExportProducts) returns (ListingExportProductsResp){
	option (common.webapi).download = true;
	option (common.webapi).interactive = true;
  }

  //导出html文件，运营可以操作页面  来导出搜索商品。
  rpc ExportHtml (ListingExportHtml) returns (ListingExportHtmlResp) {
      option (common.webapi).download = true;
  }

  // -------------------------------------------------
  // 卖家屏蔽
  // ------------------------------------------------
  // 1. 列表页
  rpc BlockVendorList(ListingBlockVendorList) returns (ListingBlockVendorListResp);
  // 2. 更改某几个卖家的信息
  rpc BlockVendorSet(ListingBlockVendorSet) returns (ListingBlockVendorSetResp);

  // ------------------------------------------------
  //  设置渠道分数
  // ------------------------------------------------
  // 1. 获取渠道分数权重
  rpc PlatformScore(ListingPlatformScore) returns (ListingPlatformScoreResp);  
  // 2. 设置渠道分数权重
  rpc PlatformScoreSet(ListingPlatformScoreSet) returns (ListingPlatformScoreSetResp);
  // 3. 批量获取
  rpc PlatformScoreMatch(ListingPlatformScoreMatch) returns (ListingPlatformScoreMatchResp);

  // ------------------------------------------------
  //  最近购买列表分标签
  // ------------------------------------------------
  // 1. 获取用户所属的类目id列表
  rpc RecentPurchaseTag(ListingRecentPurchaseTag) returns (ListingRecentPurchaseTagResp) {
	option (common.timeout) = "1s";
  }
  // 2. 列表
  rpc RecentPurchaseTagList(ListingRecentPurchaseTagList) returns (ListingRecentPurchaseTagListResp);
  // 3. 修改
  rpc RecentPurchaseTagSet(ListingRecentPurchaseTagSet) returns (ListingRecentPurchaseTagSetResp);
  // 4. 根据tagId获取dcids
  rpc RecentPurchaseTagGet(ListingRecentPurchaseTagGet) returns (ListingRecentPurchaseTagGetResp);
  // 5. 查询分组信息 - 拿到recentPurcahse的用户分组列表
  rpc RecentPurchaseTagGroupList(ListingRecentPurchaseTagGroupList) returns (ListingRecentPurchaseTagGroupListResp);

  // ------------------------------------------------
  // 商品上下架规则管理
  // ------------------------------------------------
  // 1. 获取指定类目的规则
  rpc ShelfRuleGet(ListingShelfRuleGet) returns (ListingShelfRuleGetResp);
  // 2. 查找指定类目下所有的规则(包含子类目)
  rpc ShelfRuleFindAll(ListingShelfRuleFindAll) returns (ListingShelfRuleFindAllResp);
  // 3. [中断]执行 规则(每个国家同一时刻最多只能有一个执行任务)
  rpc ShelfRuleExecute(ListingShelfRuleExecute) returns (ListingShelfRuleExecuteResp);
  // 4. 获取规则执行进度
  rpc ShelfRuleExecuteProcess(ListingShelfRuleExecuteProcess) returns (ListingShelfRuleExecuteProcessResp);
  // 5. 编辑规则
  rpc ShelfRuleEdit(ListingShelfRuleEdit) returns (ListingShelfRuleEditResp);
  // 6. 查找出所有修改后未执行的规则
  rpc ShelfRuleFindModified(ListingShelfRuleFindModified) returns (ListingShelfRuleFindModifiedResp);
  // 7. 商品库检查商品是否需要强制下架
  rpc ShelfRuleCheck(ListingShelfRuleCheck) returns (ListingShelfRuleCheckResp);
}

message ListingExportProducts {
    string url = 1;
}

message ListingExportProductsResp {
  string contentType = 1;
  bytes data = 2;
  string filename = 3;
}

message ListingExportHtml {}

message ListingExportHtmlResp {
  string contentType = 1;
  bytes data = 2;
  string filename = 3;
}

message ListingPlatformScore {
  int32 dcid = 1;
  // 当子类目找不到时, 是否匹配父级类目
  bool matchParent = 2;
}

message ListingPlatformScoreJob {
  int32 dcid = 1;
}

enum XScorePlatform {
  XScorePlatformInvalid = 0;
  XScorePlatformJingdong = 1 [(common.label)="京东"];
  XScorePlatformMogujie = 2 [(common.label)="蘑菇街"];
  XScorePlatformAmazon = 3 [(common.label)="亚马逊"];
  XScorePlatformYiqihuo = 4 [(common.label)="一起火"];
  XScorePlatformTaobao = 5 [(common.label)="淘宝"];
  XScorePlatformEzbuyCN = 6 [(common.label)="中国自营"];
  XScorePlatformEzbuyKR = 7 [(common.label)="韩国自营"];
  XScorePlatformEzbuyLocal = 8 [(common.label)="local自营"];
}

message ListingPlatformScoreItem {
  bool enable = 2;
  repeated ListingPlatformScoreItemPlatform items = 1;
}

message ListingPlatformScoreItemPlatform {
  // 渠道名称
  string platform = 1;
  int32 score = 2;
}

message ListingPlatformScoreResp {
  ListingPlatformScoreItem item = 1;
}

message ListingPlatformScoreSet {
  int32 dcid = 1;
  ListingPlatformScoreItem item = 2;
}

message ListingPlatformScoreSetResp {
  ListingPlatformScoreItem item = 1;
}

// ---------------------------------------------------------------------------

message ListingPlatformScoreMatch {
  repeated int32 dcid = 1;
  spk.XPlatform platform = 2;
  string vendor = 3;
  biz.Region region = 4;
  // 当子类目找不到时, 是否匹配父级类目
  bool matchParent = 5;
}

message ListingPlatformScoreMatchResp {
  repeated int32 score = 1;
}

// ---------------------------------------------------------------------------

message ListingBlockVendorList {
  string vendorId = 1;
}

message ListingBlockVendorListResp {
  repeated ListingBlockVendorItem items = 1;
}

message ListingBlockVendorItem {
  string id = 1;
  string platformName = 2;
  string vendorName = 3;
  string vendorId = 4;
  bool isBlockRecentPurchase = 5;
  string updateBy = 6;
  string updateDate = 7;
}


message ListingBlockVendorSet {
  ListingBlockVendorItem insert = 1;
  ListingBlockVendorItem update = 2;
  repeated string deletes = 3;
}

message ListingBlockVendorSetResp {
  
}

// ---------------------------------------------------------------------------

message ListingRecentPurchaseTag {
  int32 customerId = 1;
}

message ListingRecentPurchaseTagResp {
  repeated int32 dcids = 1;
  repeated int32 tagIds = 2;
}

message ListingRecentPurchaseTagList {
  int32 offset = 1;
  int32 limit = 2;
}

message ListingRecentPurchaseTagListResp {
  repeated ListingRecentPurchaseTagItem items = 1;
}


message ListingRecentPurchaseTagItem {
  // mongo id
  string id = 1;
  int32 tagId = 2;
  string tagName = 3;
  biz.Region catalog = 4;
  // 展示类目id
  repeated int32 dcids = 5;
  string updateBy = 6;
  int64 updateDate = 7;
  bool disabled = 8;
}

message ListingRecentPurchaseTagItemUpdate {
  int32 tagId = 1;
  repeated int32 dcids = 3;
}

message ListingRecentPurchaseTagItemOper {
  string id = 1;
  string updateBy = 6;

  common.SetI32 tagId = 2;
  common.SetStr tagName = 3;
  biz.Region catalog = 4;
  // 展示类目id
  common.SetI32s dcids = 5;
  common.SetI64 updateDate = 7;
  common.SetBool disabled = 8;
}

message ListingRecentPurchaseTagSet {
  repeated string deletes = 1;
  ListingRecentPurchaseTagItemUpdate upsert = 2;
}

message ListingRecentPurchaseTagSetResp {
  
}

message ListingRecentPurchaseTagGroupList {
}

message ListingRecentPurchaseTagGroupListItem {
  int32 tagId = 1;
  string tagName = 2;
  biz.Region catalog = 3;
}

message ListingRecentPurchaseTagGroupListResp {
  repeated ListingRecentPurchaseTagGroupListItem items = 1;
}

message ListingRecentPurchaseTagGet {
  repeated int32 tagIds = 1;
}

message ListingRecentPurchaseTagGetResp {
  repeated int32 dcids = 1;
  int32 notFound = 2;
  int32 disabled = 3;
}


// ------------------------------------------------

message XListingDcatLimit {
  map<string, int32> minPrice = 1;
  map<string, int32> maxPrice = 2;
  map<string, int32> maxWeight = 3;
  int64 maxShippingFee = 4;
  repeated string disabledShipmentType = 5;
  repeated string disabledPlatforms = 6;
}

message XListingShelfRule {
  int32 dcid = 1;
  repeated string crumb = 2;
  XListingDcatLimit limit = 3;
  string updateBy = 4;
  int64 updateDate = 5;
  int64 execDate = 6;
}

message ListingShelfRuleGet {
    string catalog = 1;
    int32 dcid = 2;
}

message ListingShelfRuleGetResp {
  XListingShelfRule rule = 1;
}

message ListingShelfRuleFindAll {
  string catalog = 1;
  int32 parentDcid = 2;
  bool modifiedOnly = 3;
}

message ListingShelfRuleFindAllResp {
  XListingShelfRule parentRule = 1;
  repeated XListingShelfRule subRules = 2;
  // 来源地列表
  repeated string origins = 3;
  repeated string platforms = 4;
  repeated string shipmentTypes = 5;
}

message ListingShelfRuleExecute {
  string catalog = 1;
  repeated int32 dcids = 2;
  // 为 true 时, dcids 不用提供
  bool abort = 3; 
}

message ListingShelfRuleExecuteResp {
  
}

message ListingShelfRuleExecuteProcess {
  string catalog = 1;
}

message ListingShelfRuleExecuteProcessResp {
  JobStatus status = 1;
  int32 current = 2;
  int32 total = 3;
  int64 updateDate = 4;
}

message ListingShelfRuleEdit {
  int32 dcid = 1;
  XListingDcatLimit limit = 2;
  string catalog = 3;
}

message ListingShelfRuleEditResp {
}

message ListingShelfRuleFindModified {
  string catalog = 1;
  int32 parentDcid = 2;
}

message ListingShelfRuleFindModifiedResp {
  repeated XListingShelfRule rules = 2;
}

message XJobListingShelfRule {
  int32 dcid = 1;
  biz.Region catalog = 2;
  string updateBy = 3;
}

message XJobListingShelfRuleProduct {
  string poolId = 1;
  biz.Region catalog = 2;
  bool setForceOOS = 3;
  string updateBy = 4;
}

enum XListingShelfRuleBlockType {
  XListingShelfRuleBlockTypeOK = 0;
  XListingShelfRuleBlockTypeMaxPrice = 1;
  XListingShelfRuleBlockTypeMinPrice = 2;
  XListingShelfRuleBlockTypeMaxWeight = 3;
  XListingShelfRuleBlockTypeMaxShippingFee = 4;
  XListingShelfRuleBlockTypeDisabledShipment = 5;
  XListingShelfRuleBlockTypeDisabledPlatform = 6;
  XListingShelfRuleBlockTypeAlreadyBlocked = 10;
}

message ListingShelfRuleCheck {
  spk.ItemSyncGetBaseByItem prod = 1;
  repeated spk.XItemBaseDcid dcidPath = 2;
}

message ListingShelfRuleCheckItem {
  biz.Region catalog = 1;
  bool forceOOS = 2;
  XListingShelfRuleBlockType blockType = 3;
  int32 hitDcid = 4;
}

message ListingShelfRuleCheckResp {
  repeated ListingShelfRuleCheckItem items = 1;
}

message XListingShelfRuleCacheGroup {
  repeated XListingShelfRuleCache items = 1;
}

message XListingShelfRuleCache {
  int32 dcid = 1;
  biz.Region catalog = 8;
  repeated XListingShelfRuleCacheCatalog maxWeight = 2;
  repeated XListingShelfRuleCacheCatalog maxPrice = 3;
  repeated XListingShelfRuleCacheCatalog minPrice = 4;
  repeated XListingShelfRuleCacheCatalog maxShippingFee = 5;
  repeated spk.XEzbuyShipment disabledShipmentType = 6;
  repeated spk.XPlatform disabledPlatforms = 7;
  int64 updateDate = 9;
}

message XListingShelfRuleCacheCatalog {
  biz.Region region = 1;
  int64 value = 2;
}
