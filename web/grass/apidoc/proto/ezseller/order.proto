syntax = "proto3";
package ezseller;

import "common/ezbuy.proto";
import "ezseller/result.proto";
import "ezOrder/order.proto";
import "biz/region.proto";

service Order {
    option (common.service).webapi = true;
    option (common.service).public = true;

    // 生成订单
    rpc CommitOld (OrderCommitOld) returns (OrderCommitOldResp);

    // 更新跟踪信息
    rpc UpdateTrack (OrderUpdateTrack) returns (OrderUpdateTrackResp);

    // 发货
    rpc Dispatch (OrderDispatch) returns (OrderDispatchResp);

    // 更新状态
    rpc UpdateTrackStatus (OrderUpdateTrackStatus) returns (OrderUpdateTrackStatusResp);

    // 取消
    rpc Cancel (OrderCancel) returns (OrderCancelResp);

    // 搜索卖家订单信息
    rpc Search (OrderSearch) returns (OrderSearchResp);

    // 卖家订单发货
    rpc SellerDispatch (OrderSellerDispatch) returns (OrderSellerDispatchResp);

    // 卖家订单缺货登记
    rpc ItemNotInStock (OrderItemNotInStock) returns (OrderItemNotInStockResp);

    // 生成订单(接采购分配)
    rpc Commit (OrderCommit) returns (OrderCommitResp);

    // 按orderNum 更新物流信息
    rpc UpdateTrackByOrderNum (OrderUpdateTrackByOrderNum) returns (OrderUpdateTrackByOrderNumResp);

    // 增加备注
    rpc Remark (OrderRemark) returns (OrderRemarkResp);

    // 批量增加备注
    rpc RemarkMulit (OrderRemarkMulit) returns (OrderRemarkMulitResp);

    // 根据订单 NewOrderId 反查分配请求
    rpc CommitRequest (OrderCommitRequest) returns (OrderCommitRequestResp);

    // 根据订单号查询卖家订单详情
    rpc GetOrderItemByNumber (GetOrderItemByNumberReq) returns (GetOrderItemByNumberResp);
    
	// 查询新订单基本信息
	rpc GetBaseInfo(GetBaseInfoReq) returns (GetBaseInfoResp);

    // 订单实收数量
    rpc StockInQtyAlter (StockInQtyAlterReq) returns (StockInQtyAlterResp);

    // 查询实收数量
    rpc GetStockInQty (GetStockInQtyReq) returns (GetStockInQtyResp);

    // 获取卖家订单物流信息
    rpc GetUserOrderShipment (GetUserOrderShipmentReq) returns (GetUserOrderShipmentResp);

    // 追加卖家物流运单号
    rpc AppendUserOrderShipmentNumber (AppendUserOrderShipmentNumberReq) returns (AppendUserOrderShipmentNumberResp);

    // 订单列表查询数据接口（逻辑层数据层分离）
    rpc SearchOrderLists (SearchOrderListsReq) returns (SearchOrderListsResp);

    // 获取单个订单详情接口 (逻辑层数据层分离)
    rpc OrderItemDetail (OrderItemDetailReq) returns (OrderItemDetailResp);

    // 老订单发货接口 （逻辑层数据层分离）  老订单彻底下线的时候可以干掉这个接口
    rpc OldOrderItemDispatch (OldOrderItemDispatchReq) returns (OldOrderItemDispatchResp);

    rpc SelfShopList(SelfShopListReq) returns (SelfShopListResp);

    rpc IsSelfShop(IsSelfShopReq) returns (IsSelfShopResp);

    //order item级别的订单相关接口 (ONLY FOR OPEN API)

    // 新的订单搜索
    rpc SearchOrder4API (OrderNewSearch) returns (OrderNewSearchResp);

    // 新的订单发货
    rpc DispatchOrder4API (OrderSellerDispatch) returns (OrderSellerDispatchResp);

    // 新的订单缺货登记
    rpc RegisterOutOfStock4API (OrderNewItemNotStock) returns (OrderNewItemNotStockResp);

    // 新的修改订单运单信息
    rpc UpdateTrack4API (OrderUpdateTrackByOrderNum) returns (OrderUpdateTrackByOrderNumResp);

    // 追加卖家物流运单号
    rpc AppendShipmentNumber4API (AppendShipmentNumber4APIReq) returns (AppendShipmentNumber4APIResp);
    
    // for stat

    // 拉取订单短时间的聚合数据
    rpc AggSellerOrderData(AggSellerOrderDataReq) returns (AggSellerOrderDataResp);

    // 查询店铺时间段内的卖家原因取消数量
    rpc GetSellerCancelCount(GetSellerCancelCountReq) returns (GetSellerCancelCountResp);

}

enum OrderItemStyle {
    OrderItemStyleUnknown = 0;
    OrderItemStyleOldCart = 1; // 老购物车, 对应一个 OrderItem
    OrderItemStyleNewCart = 2; // 新购物车, 对应一个 user_order_item
    OrderItemStyleMixedCart = 3; // 来自采购分配,
}

enum OrderItemType {
    // (1000, 2000) 流向: seller => ezbuy
    // (2000, 3000) 流向 ezbuy => seller
    // 结算金额系数: 10xx => 1; 11xx, 21xx => 0; 20xx => -1;

    OrderItemTypeUnknown = 0;

    // 需发件, 结算商品费用
    OrderItemTypeNormal = 1001; // 正常下单
    OrderItemTypeAdd = 1002; // 补件

    // 需发件, 不结算商品费用
    OrderItemTypeIncomplete = 1101; // 少件补发

    // 需收件, 扣减商品费用
    OrderItemTypeReturn = 2001; // 退件

    // 不需收件, 扣减商品费用
    OrderItemTypeShortBalance = 2051; // 缺件补偿

    // 需收件, 不扣商品费用
    OrderItemTypeUnnecessary = 2101; // 多发或用户已取消但卖家已发货, 退还
}

enum OrderItemFeeType {
    OrderItemFeeTypeUnknown = 0;
    OrderItemFeeTypeProduct = 1; // 商品费用
    OrderItemFeeTypePostage = 2; // 邮费
    OrderItemFeeTypeOther = 3; // 其他
    OrderItemFeeTypePlatformPromotionDiscount = 4; // 平台活动摊分金额
    OrderItemFeeTypeLocalDelivery = 5; // 本地派送费
    OrderItemFeeTypePurchasePrice = 6; // 商品成本费用
}

enum OrderItemWrapperType {
    OrderItemWrapperTypeUnknown = 0;
    OrderItemWrapperTypeAsEzbuyOrder = 1; // 按 ezbuy 订单打包
    OrderItemWrapperTypeAsEzbuyPackage = 2; // 按 ezbuy 包裹打包
}

enum OrderItemRemarkSource {
    OrderItemRemarkSourceUnknown = 0;
    OrderItemRemarkSourceEzbuyCustomer = 100; // ezbuy 用户
    OrderItemRemarkSourceEzbuyOp = 200; // ezbuy 运营
    OrderItemRemarkSourceEzSeller = 300; // 卖家
}

enum OrderItemWarehouse {
    OrderItemWarehouseUnknown = 0;
    OrderItemWarehouseShanghai = 1; // 上海/嘉兴
    OrderItemWarehouseGuangzhou = 2; // 广州/东莞
    OrderItemWarehouseAmerican = 3; // 美国
    OrderItemWarehouseTaiwan = 4; // 台湾
    OrderItemWarehouseSingapore = 5; // 新加坡
    OrderItemWarehouseMalaysia = 6; // 马来西亚
    OrderItemWarehouseINCHEON = 7; // 仁川
    OrderItemWarehouseJapan = 8; // 日本
}

enum OrderItemDestination {
    OrderItemDestinationUnknown = 0;
    OrderItemDestinationSG = 1;
    OrderItemDestinationMY = 2;
    OrderItemDestinationTH = 3;
    OrderItemDestinationID = 4;
}

enum OrderItemBillStatus {
    OrderItemBillStatusUnknown = 0;
    OrderItemBillStatusPending = 1000; // 未入账单
    OrderItemBillStatusBilled = 2000; // 已入账单
}

enum OrderItemTrackStatus {
    OrderItemTrackStatusUnknown = 0;
    // 对应 (1000, 2000) 的订单类型
    OrderItemTrackStatusCancelled = 1000001; // 取消
    OrderItemTrackStatusPending = 1003000; // 待发货; 对应 PURCHASING_ORDER;
    OrderItemTrackStatusDispatched = 1004000; // 已发货; 对应 PURCHASING_SEND_OUT;
    OrderItemTrackStatusWarehouseReceived = 1006000; // 采购仓库已入库; 对应 PURCHASING_GET;
    OrderItemTrackStatusPendingDelivery = 1016000; // 待派送; 对应 PENDING_SEND;
    OrderItemTrackStatusCompleted = 1021000; // 已完成; 对应 FINISH;

    // 对应 (2000, 3000) 的订单类型
    OrderItemTrackStatusReturnPending = 2001000; // 退件-待发货
    OrderItemTrackStatusReturnDispatched = 2002000; // 退件-已发货
    OrderItemTrackStatusReturnCompleted = 2011000; // 退件-已收件
}

enum OrderItemPromotionType {
    OrderItemPromotionTypeUnknown = 0;
    OrderItemPromotionTypeFlashSale = 100001; // 闪购
    OrderItemPromotionTypeCashOff = 100002; // 满减
    OrderItemPromotionTypeFriendsDeal = 100003; // 团购
    OrderItemPromotionTypeFreeShipping = 100004; // 包邮
    OrderItemPromotionTypeMNCashOff = 100005; // 满 M 减 N
    OrderItemPromotionTypeMixed = 200000; // 多活动混合

    // old types
    OrderItemPromotionTypeOldFlashSale = 900001;
    OrderItemPromotionTypeOldCashOff = 900002;
    OrderItemPromotionTypeOldFriendsDeal = 900003;
    OrderItemPromotionTypeOldFreeShipping = 900004;
}

enum OrderItemSortBy {
    Unknown = 0;
    PaymentTimeDESC = 1;
    PaymentTimeASC = 2;
    OrderDispatchTimeDESC = 3;
    CancelDateDESC = 4;
}

// ---- 生成订单 ----
message OrderCommitOldItem {
    int64 id = 1;
    bool forMigrate = 2;
}

message OpResult {
    int32 code = 1;
    string error = 2;
}

message OrderCommitOld {
    repeated OrderCommitOldItem item = 1;
}

message OrderCommitOldResp {
    repeated OpResult result = 1;
}

// ---- 更新跟踪信息 ----
message OrderUpdateTrackItem {
    int64 id = 1;
    string shipper = 2;
    string trackingNumber = 3;
}

message OrderUpdateTrack {
    repeated OrderUpdateTrackItem item = 1;
}

message OrderUpdateTrackResp {
    repeated OpResult result = 1;
}

// ---- 发货 ----
message OrderDispatchItem {
    int64 id = 1;
    string shipper = 2;
    string trackingNumber = 3;
}

message OrderDispatch {
    repeated OrderDispatchItem item = 1;
}

message OrderDispatchResp {
    repeated OpResult result = 1;
}

// ---- 更新状态 ----
message OrderUpdateTrackStatusItem {
    int64 id = 1;
    OrderItemTrackStatus status = 2;
}

message OrderUpdateTrackStatus {
    repeated OrderUpdateTrackStatusItem item = 1;
}

message OrderUpdateTrackStatusResp {
    repeated OpResult result = 1;
}

// ---- 取消 ----
message OrderCancelItem {
    int64 id = 1;
}

message OrderCancel {
    repeated OrderCancelItem item = 1;
}

message OrderCancelResp {
    repeated OpResult result = 1;
}

// 订单搜索
message OrderSearch {
    int32 shopId = 1;
    string AppName = 2;
    repeated string orderNumber = 3;
    repeated int32 status = 4;
    repeated int64 startPayDate = 5;
    repeated int64 endPayDate = 6;
    int32 pageIndex = 7;
    int32 pageSize = 8;
}

message OrderInfo {
    string orderNumber = 1;
    int32 productId = 2;
    string productName = 3;
    int32 status = 4;
    int64 createDate = 5;
    int64 paidDate = 6;
    repeated OrderItem items = 7;
    int32 warehouse = 8;
    string remark = 9;
}

message OrderItem {
    int32 orderItemId = 1;
    int32 skuId = 2;
    string skuName = 3;
    double unitPrice = 4;
    int32 quantity = 5;
    int32 status = 6;
    string sellerSkuId = 7;
}

message OrderSearchResp {
    int32 totalCount = 1;
    repeated OrderInfo orders = 2;
}

//卖家订单发货
message OrderSellerDispatch {
    int32 shopId = 1;
    string appName = 2;
    string orderNumber = 3;
    string shipperName = 4;
    string trackingNumber = 5;
}

message OrderSellerDispatchResp {
    bool success = 1;
    string message = 2;
}

//卖家订单缺货登记
message OrderItemNotInStock {
    int32 shopId = 1;
    string appName = 2;
    string orderNumber = 3;
    repeated SkuStockOut skus = 4;
}
//sku缺货信息
message SkuStockOut {
    int32 skuId = 1;
    int32 quantity = 2;
    string reason = 3;
}

message OrderItemNotInStockResp {
    bool success = 1;
    string message = 2;
}

// ---- 生成订单(接采购分配) ----
message OrderCommitOrder {
    uint64 id = 1; // order_id
    uint64 customerID = 2; // customer_id
    int32 regionID = 3; // order region_id, as is defined in http://gitlab.1dmy.com/ezbuy/base/blob/master/dist/proto/biz/region.pb.go
    repeated OrderCommitOrderItem item = 4; // order items
    int64 createDate = 5; // order create date
    int64 payDate = 6; // order pay date
}

message OrderCommitOrderItem {
    uint64 id = 1; // order_item_id
    uint64 gpid = 2; // gpid
    uint64 skuID = 3; // sku_id
    int64 qty = 4; // 数量
    int64 unitPrice = 5; // 单位价格
    int32 shipmentTypeID = 6; // shipment_type_id
    OrderItemWarehouse warehouse = 7; // warehouse
    string remark = 8; // 备注
    bool unavailable = 9; // sku 信息校验未通过
    int64 originPurchasePrice = 10; // 商品成本价（即卖家发布价格） 
}

message OrderCommit {
    repeated OrderCommitOrder order = 1;
}

message OrderCommitResp {
    repeated OpResult result = 1;
}

message OrderUpdateTrackByOrderNum {
    int32 shopId = 1; //店铺id
    string appName = 2; //第三方应用名称
    string orderNum = 3;
    string shipper = 4;
    string trackingNumber = 5;
}

message OrderUpdateTrackByOrderNumResp {
    bool success = 1;
    string message = 2;
}

message OrderRemark {
    uint64 orderId = 1;
    string remark = 2;
    OrderItemRemarkSource source = 3;
    string createBy = 4;
    int64 createDate = 5;
}

message OrderRemarkMulit {
    repeated OrderRemark remarks = 1;
}

message OrderRemarkResp {
    OpResult result = 1;
}

message OrderRemarkMulitResp {
    OpResult result = 1;
}

message OrderCommitRequest {
    uint64 newOrderId = 1;
}

message OrderCommitRequestResp {
    OrderCommitOrder request = 1;
}


message GetOrderItemByNumberReq {
    string orderNumber = 1;
}

message GetOrderItemByNumberResp {
    Result result = 1;
    string orderNumber = 2;
    int64 orderItemId = 3;
    int64 productId = 4;
    string productName = 5;
    double orderAmount = 6;
    int32 shopId = 7;
    string shopName = 8;
    bool alreadySettled = 9;
}

message OrderNewSearch {
    int32 shopId = 1;
    string AppName = 2;
    repeated string orderNumber = 3;
    repeated OrderItemTrackStatus status = 4;
    repeated int64 startPayDate = 5;
    repeated int64 endPayDate = 6;
    int32 pageIndex = 7;
    int32 pageSize = 8;
    repeated int64 startCancelDate = 9;
    repeated int64 endCancelDate = 10;
}

message OrderNewSearchResp {
    int64 totalCount = 1;
    repeated NewOrderInfo orderList = 2;
}

message NewOrderInfo {
    string orderNumber = 1;
    string productName = 2;
    int64 productId = 3;
    string sellerSkuId = 4;
    string skuName = 5;
    double unitPrice = 6;
    int64 quantity = 7;
    OrderItemTrackStatus status = 8;
    OrderItemWarehouse warehouse = 9; //仓库代码
    int64 payDate = 10; //付款时间
    int64 dispatchDate = 11; //发货时间
    string remark = 12; //用户备注
    int64 cancelDate = 13; // 订单取消时间

}

message OrderNewItemNotStock {
    int32 shopId = 1;
    string appName = 2;
    string orderNumber = 3;
    int32 quantity = 4;
    string reason = 5;
}

message OrderNewItemNotStockResp {
    bool success = 1;
    string message = 2;
}

message StockInQtyAlterReq {
    uint64 newOrderId = 1;
    uint64 newOrderItemId = 2;
    int32 qtyAlter = 3;
    ezOrder.OrderItemOperType reason = 4;
}

message StockInQtyAlterResp {
    OpResult result = 1;
}

message GetStockInQtyReq {
    repeated string orderItemNum = 1;
}

message GetStockInQtyResp {
    repeated GetStockInQty stockInQty = 1;
}

message GetStockInQty {
    string orderItemNum = 1;
    int32 qty = 2;
}

message Shipment {
    int64 trackId = 1;
    int64 orderItemId = 2;
    string shipper = 3;
    string trackNumber = 4;
}

message GetUserOrderShipmentReq {
    int64 orderItemId = 1;
}

message GetUserOrderShipmentResp {
    Result result = 1;
    repeated Shipment shipments = 2;
}

message AppendUserOrderShipmentNumberReq {
    Shipment shipment = 1;
}

message AppendUserOrderShipmentNumberResp {
    Result result = 1;
}

message AppendShipmentNumber4APIReq {
    string orderNumber = 1;
    string shipper = 2;
    string trackNumber = 3;
}

message AppendShipmentNumber4APIResp {
    Result result = 1;
}

message GetBaseInfoReq {
	repeated uint64 orderItemId = 1;
	repeated string orderItemNum = 2;
}

message GetBaseInfoResp {
	repeated BaseInfo baseInfos = 1;
}

message BaseInfo {
	uint64 orderItemId = 1;
	string orderItemNum = 2;
	int32 pkgId = 3;
	int32 warehouse = 4;
	int64 createDate = 5;
	int64 finishedDate = 6;
	int64 dispatchDate = 7;
	int64 arrievedTransDate = 8;
    int32 prodRegion = 9;
    int32 prodId = 10;
    string prodName = 11;
    int64 billableAt = 12;
}

message AggSellerOrderDataReq {
    int32 shopId = 1; // optional
    int64 from = 2; // 开始时间
    int64 to = 3; // 结束时间
}

message AggSellerOrderDataItem {
    int32 shopId = 1; // 店铺id
    int32 orderCount = 2; // 订单数
    int64 dispathAging = 3; // 发货时效
    int32 overtimeCount = 4; // 超过72小时数量
    

}

message AggSellerOrderDataResp {
    Result result = 1;
    repeated AggSellerOrderDataItem items  = 2;
}

message GetSellerCancelCountReq {
    int32 shopId = 1; // 店铺id
    int64 from = 2;
    int64 to = 3;
}

message GetSellerCancelCountItem {
    int32 shopId = 1;
    int32 count = 2;
}

message GetSellerCancelCountResp {
    Result result = 1;
    repeated GetSellerCancelCountItem items = 2;
}

message SearchOrderListsReq {
    int32 offset = 1;
    int32 limit = 2;
    SearchOrderListsFilter filter = 3;
    CountOption countOption = 4;
    OrderItemSortBy orderItemSortBy = 5;
}

enum CountOption {
    CountOptionUnknown = 0;
    CountOptionCountWitchStatus = 1;
    CountOptionCount = 2;
} 

message SearchOrderListsFilter {
    string orderNum = 1;
    int64 paymentTimeStart = 2;
    int64 paymentTimeEnd = 3;
    OrderItemWarehouse warehouse = 4;
    string productName = 5;
    string productUrl = 6;
    string sellerSkuId = 7;
    int64 deliveryTimeStart = 8;
    int64 deliveryTimeEnd = 9;
    string trackingNum = 10;
    OrderItemTrackStatus orderItemTrackStatus = 11;
    repeated string orderNumList = 12;
    int64 billDateStart = 13;
    int64 billDateEnd = 14;
    int64 cancelDateStart = 15;
    int64 cancelDateEnd = 16;
    int32 shopId = 17;
    string shopName = 18;
    int64 finishedDateStart = 19;
    int64 finishedDateEnd = 20;
    biz.Region prodRegion = 21;
    bool dispatchDelayedOnly = 22;
}

message SearchOrderListsResp {
    repeated OrderListItem Lists = 1;
    repeated CountWitchStatus countWitchStatus = 2;
    int32 count = 3;
}

message CountWitchStatus {
    OrderItemTrackStatus status = 1;
    int32 count = 2;
}

message OrderListItem {
    string productImg = 1;
    uint64 orderItemId = 2;
    string orderItemNum = 3;
    int32 productId = 4;
    string sellerSkuId = 5;
    string productName = 6;
    string skuName = 7;
    repeated OrderItemPromotionType activity = 8;
    int64 unitPrice = 9;
    int32 quantity = 10;
    OrderItemWarehouse warehouse = 11;
    OrderItemTrackStatus orderStatus = 12;
    repeated OrderItemRemark remarks = 13;
    int64 createdAt = 14;
    int64 billDate = 15;
    biz.Region cusRegion = 16;
    int32 stockInQty = 17;
    ezOrder.OrderItemOperType reason = 18;
    int64 trackTime = 19;
    int64 ticketId = 20;
    int64 cancelDate = 21;
    int64 ezShipmentTypeId = 22;
    int64 ezOrderId = 23;
    double unitOffsetRatio = 24;
    int64 unitOffsetAmount = 25;
    int64 totalOffsetAmount = 26;
    int64 purchaseUnitPrice = 27;
    int64 finishedAt = 28;
    int64 dispatchedAt = 29;
    int64 arrivedAt = 30;
    biz.Region prodRegion = 31;
    string ezOrderNum = 32;
    string shopName = 33;
}

message OrderItemRemark{
    string remark = 1;
    int64 createdAt = 2;
    string userName = 3;
    OrderItemRemarkSource source = 4;
}

message OrderItemDetailReq {
    uint64 orderItemId = 1;
    string orderItemNum = 2;
}

message OrderItemDetailResp {
    uint64 orderItemId = 1;
    string orderItemNum = 2;
    OrderItemTrackStatus orderItemStatus = 3;
    bool IsActive = 4;
    int32 shopId = 5;
}

message OldOrderItemDispatchReq {
    uint64 orderItemId = 1;
    string provider = 2;
    string trackingNum = 3;
}

message OldOrderItemDispatchResp {
    OpResult result = 1;
}

message SelfShopListReq {
}

message SelfShopListResp {
    repeated ShopInfo ShopList = 1;
}

message ShopInfo {
    int32 shopId = 1;
    string shopName = 2;
}

message IsSelfShopReq {
    int32 shopId = 1;
}

message IsSelfShopResp {
    bool isSelf = 1;
}
