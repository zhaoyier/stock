syntax = "proto3";
package garencieres;

import "garencieres/common.proto";
import "common/ezbuy.proto";
import "common/empty.proto";
import "common/html.proto";

//! erp 2.0 服务接口
service Erp {
	option (common.service).webapi = true;

	//! 仓库管理
	rpc FetchWarehouse(ErpFetchWarehouse) returns (ErpFetchWarehouseResp);
	rpc CreateWarehouse(ErpCreateWarehouse) returns (common.Empty);
	rpc UpdateWarehouse(ErpUpdateWarehouse) returns (common.Empty);
	rpc DeleteWarehouse(ErpDeleteWarehouse) returns (common.Empty);
	rpc SearchWarehouse(ErpSearchWarehouse) returns (ErpSearchWarehouseResp);

	//! 区域管理
	rpc FetchArea (ErpFetchArea) returns (ErpFetchAreaResp);
	rpc CreateArea (ErpCreateArea) returns (common.Empty);
	rpc UpdateArea (ErpUpdateArea) returns (common.Empty);
	rpc DeleteArea (ErpDeleteArea) returns (common.Empty);
	rpc SearchArea (ErpSearchArea) returns (ErpSearchAreaResp);

	//! 库区管理
	rpc FetchWarehouseArea(ErpFetchWarehouseArea) returns (ErpFetchWarehouseAreaResp);
	rpc CreateWarehouseArea(ErpCreateWarehouseArea) returns (common.Empty);
	rpc UpdateWarehouseArea(ErpUpdateWarehouseArea) returns (common.Empty);
	rpc DeleteWarehouseArea(ErpDeleteWarehouseArea) returns (common.Empty);
	rpc SearchWarehouseArea(ErpSearchWarehouseArea) returns (ErpSearchWarehouseAreaResp);
	rpc GetMinEndGroup (ErpGetMinEndGroup) returns (ErpGetMinEndGroupResp);

	//! 库位管理
	rpc FetchLocation(ErpFetchLocation) returns (ErpFetchLocationResp);
	rpc CreateLocation(ErpCreateLocation) returns (ErpCreateLocationResp);
	rpc DisableLocation(ErpDisableLocation) returns (common.Empty);
	rpc EnableLocation(ErpEnableLocation) returns (common.Empty);
	rpc DeleteLocation (ErpDeleteLocation) returns (common.Empty);
	rpc SearchLocation(ErpSearchLocation) returns (ErpSearchLocationResp);
	// 下架接口
	rpc SoldOutLocation (ErpSoldOutLocation) returns (ErpSoldOutLocationResp);
	// 获取检货信息。
	rpc GetPickupInfo (ErpGetPickupInfo) returns (ErpGetPickupInfoResp);
	rpc ExportLocation (ErpExportLocation) returns (ErpExportLocationResp) {
		option (common.webapi).download = true;
	}
	// 只允许类型从A-B之间切换
	rpc UpdateLocation (ErpUpdateLocation) returns (common.Empty);

	//! 库位类型管理
	rpc FetchLocationType(ErpFetchLocationType) returns (ErpFetchLocationTypeResp);
	// 后台接口
	rpc CreateLocationType(ErpCreateLocationType) returns (common.Empty);
	rpc UpdateLocationType(ErpUpdateLocationType) returns (common.Empty);
	rpc DeleteLocationType(ErpDeleteLocationType) returns (common.Empty);

	rpc SearchLocationType(ErpSearchLocationType) returns (ErpSearchLocationTypeResp);
	// 释放由于修改sku数量改变的商品重量
	rpc ReleaseLocation (ErpReleaseLocation) returns (common.Empty);
	// 回退导致重计算入库库容。
	rpc ReleaseStockin (ErpReleaseStockin) returns (common.Empty);

	//! 预分配规则
	rpc FetchDistributeRule (ErpFetchDistributeRule) returns (ErpFetchDistributeRuleResp);
	rpc CreateDistributeRule (ErpCreateDistributeRule) returns (common.Empty);
	rpc UpdateDistributeRule (ErpUpdateDistributeRule) returns (common.Empty);
	rpc DeleteDistributeRule (ErpDeleteDistributeRule) returns (common.Empty);
	rpc SearchDistributeRule (ErpSearchDistributeRule) returns (ErpSearchDistributeRuleResp);
	// 分配货架
	rpc DistributeLocation (ErpDistributeLocation) returns (ErpDistributeLocationResp);
	// 库位已生成，但入库服务失败回滚导致库位管理的回滚
	rpc StockinRollBack (ErpStockinRollBack) returns (common.Empty);

	// 后台接口，便于测试  修复线上库容和job的问题。
	rpc RecheckLocation (ErpRecheckLocation) returns (common.Empty);

	// 查询后台
	rpc ReportLocation(common.Empty) returns (common.Html);

	// 临时接口，用于刷新上架log脏数据，给BI统计
	rpc UpdatePutawayLog (common.Empty) returns (common.Empty);
	//GetLocationType 根据库位号判断库位类型
	rpc GetLocationType (GetLocationTypeReq) returns (GetLocationTypeResp);

	// 导出库位和用户数量
	rpc ExportLocCustomer (ErpExportLocCustomer) returns (ErpExportLocCustomerResp) {
		option (common.webapi).download = true;
	};

    rpc GetStockInfoByOrderNos(GetStockInfoByOrderNosReq) returns (GetStockInfoByOrderNosResp);
    rpc GetOrderInfoByStockinCodes(GetOrderInfoByStockinCodesReq)  returns(GetOrderInfoByStockinCodesResp);
}

message GetLocationTypeReq{
	repeated string locationCodes = 1;
}

message GetLocationTypeResp{
	map<string,int32> locationRes = 1;
}

//! warehouse crud messages
message ErpFetchWarehouse{
	int64 id = 1;
	int32  offset = 2;
	int32  limit = 3;
}

message ErpFetchWarehouseResp{
	repeated Warehouse items = 1;
}

message ErpCreateWarehouse{
	Warehouse data = 1;
}

message ErpUpdateWarehouse{
	Warehouse data = 1;
}

message ErpDeleteWarehouse{
	repeated int64 ids = 1;
}

message ErpSearchWarehouse{
	int64 id = 1;
	string name = 2;
	int32 warehourseType = 3;
	int32  offset = 4;
	int32  limit = 5;
}

message ErpSearchWarehouseResp{
	repeated Warehouse items = 1;
	int64 total = 2;
}

//! area crud messages
message ErpFetchArea {
	int64 id = 1;
	int64 warehouseId = 2;
	AreaField originNation = 3;
	int32 offset = 4;
	int32 limit = 5;
}

message ErpFetchAreaResp {
	repeated Area items = 1;
}

message ErpCreateArea {
	Area data = 1;
}

message ErpUpdateArea {
	Area data = 1;
}

//! 逻辑删除
message ErpDeleteArea {
	repeated int64 ids = 1;
}

message ErpSearchArea {
	int64 id = 1;
	int64 warehouseId = 2;
	AreaField originNation = 3;
	int32 offset = 4;
	int32 limit = 5;
}

message ErpSearchAreaResp {
	repeated Area items = 1;
	int64 total = 2;
}

//! warehouse area crud messages
message ErpFetchWarehouseArea{
	int64 id = 1;
	int64 regionId = 2;
	int64 warehouseId = 3;
	int64 areaId = 4;
	int64 shipmentTypeId = 5;
	WarehouseAreaField categoryId = 6;
	int32 offset = 7;
	int32 limit = 8;
}

message ErpFetchWarehouseAreaResp{
	repeated WarehouseArea items = 1;
}

message ErpCreateWarehouseArea{
	WarehouseArea data = 1;
}

message ErpUpdateWarehouseArea{
	WarehouseArea data = 1;
	int32 minEndGroup = 2;
}

message ErpDeleteWarehouseArea{
	repeated int64 ids = 1;
}

message ErpSearchWarehouseArea{
	int64 id = 1;
	int64 regionId = 2;
	int64 warehouseId = 3;
	int64 areaId = 4;
	int64 shipmentTypeId = 5;
	WarehouseAreaField categoryId = 6;
	int32 offset = 7;
	int32 limit = 8;
}

message ErpSearchWarehouseAreaResp{
	repeated WarehouseAreaView items = 1;
	int64 total = 2;
}

message ErpGetMinEndGroup {
	int64 warehouseAreaId = 1;
	int64 warehouseId = 2;
	int32 atGroup = 3;
	int32 endGroup = 4;
}

message ErpGetMinEndGroupResp {
	int32 minEndGroup = 1;
}

//! location crud messages
message ErpFetchLocation{
	int64 id = 1;
	string stockinCode = 2;
}

message ErpFetchLocationResp{
	Location data = 1;
}

message ErpCreateLocation{
	Location location = 1;
	int32 scopeX = 2;
	int32 scopeY = 3;
	int32 scopeZ = 4;
	bool IsActive = 5;
}

message ErpCreateLocationResp {
	repeated string codes = 1;
}

message ErpDisableLocation{
	repeated int64 ids = 1;
}

message ErpEnableLocation{
	repeated int64 ids = 1;
}

message ErpDeleteLocation {
	repeated int64 ids = 1;
	repeated int64 warehouseAreaIds = 2;	//删除对应库区的所有库位
}

message ErpSearchLocation{
	int64  warehouseId = 1;
	int64  warehouseAreaId = 2;
	int64  locationTypeId = 3;
	int64  areaId = 4;
	string locationCode = 5;
	int32  isActive = 6;  // 0表示全部，1表示开启，2表示关闭
	int32  offset = 7;
	int32  limit = 8;
	LocTypeField locType = 9;
}

message ErpSearchLocationResp{
	repeated LocationView items = 1;
	int64 total = 2;
}

message ErpSoldOutItem {
	int64 orderId = 1;
	int64 orderItemId = 2;
}

// 二选一，如果都给，已stockin为准。
message ErpSoldOutLocation {
	repeated ErpSoldOutItem items = 1;	// 兼容老系统
	repeated string stockinCodes = 2;
	int64 uid = 3;
	bool isSmall = 4; 	// 兼容老的，老的都是强制置为下架
}

message ErpSoldOutLocationResp {
	repeated string stockinCodes = 1;
}

message ErpGetPickupInfo {
	int64 warehouseAreaId = 1;
	LocTypeField locType = 2;
	int64 startTime = 3;		// 上架时间
	int64 endTime = 4;			// 上架时间
	int32 offset = 5;
	int32 limit = 6;
}

message ErpStockinItem {
	string stockinCode = 1;
	int64 orderId = 2;
	int64 weight = 3; 				// 单位 g
	int64 locationId = 4;
	string locationCode = 5;		// 库位编号
	LocTypeField locType = 6;		// 库位类型
	int64 shipmentTypeId = 7;		// 运输方式
	int64 serviceTypeId = 8;		// 服务方式
	int64 locationRank = 9;			// 库位排序
	int64 shipmentId = 10;			// b4m二次提交
}

message ErpGetPickupInfoResp {
	int64 warehouseAreaId = 1;
	string warehouseAreaCode = 2;	// 库区编号
	string warehouseAreaName = 3;
	int64 shipmentTypeId = 4;
	repeated ErpStockinItem stockin = 5;
	int64 total = 6;
}

message ErpExportLocation {
	int64 warehouseId = 1;
}

message ErpExportLocationResp {
	string contentType = 1;
	bytes data = 2;
	string filename = 3;
}

message ErpUpdateLocation {
	repeated int64 ids = 1;
	int64 locationTypeId = 2;
}

//! location type crud messages
message ErpFetchLocationType{
	int64 id = 1;
}

message ErpFetchLocationTypeResp{
	LocationType data = 1;
}

message ErpCreateLocationType{
	int64 warehouseId = 1;
	repeated LocationType datas = 2;
}

message ErpUpdateLocationType{
	LocationType data = 1;
}

message ErpDeleteLocationType{
	repeated int64 ids = 1;
}

message ErpSearchLocationType{
	int64   id = 1;
	int32  offset = 2;
	int32  limit = 3;
	int64 warehouseId = 4;
}

message ErpSearchLocationTypeResp{
	repeated LocationType items = 1;
	int64 total = 2;
}

//! 预分配规则
message ErpFetchDistributeRule {
	int64 id = 1;
}

message ErpFetchDistributeRuleResp {
	DistributeRule data = 1;
}

message ErpCreateDistributeRule {
	DistributeRule data = 1;
}

// 只能修改预分配组和备用组
message ErpUpdateDistributeRule {
	int64 id = 1;
	int64 warehouseAreaId = 2;
	int32 atGroup = 3;
	int32 endGroup = 4;
	int32 backupGroup = 5;
	bool isForce = 6;
}

message ErpDeleteDistributeRule {
	repeated int64 ids = 1;
}

message ErpSearchDistributeRule {
	int64 id = 1;
	int64 regionId = 2;
	int64 warehouseId = 3;
	int64 shipmentTypeId = 4;
	int64 warehouseAreaId = 5;
	int64 deliveryTypeId = 6;
	int32 offset = 7;
	int32 limit = 8;
}

message ErpSearchDistributeRuleResp {
	repeated DistributeRuleView items = 1;
	int64 total = 2;
}

message ErpOrderItemInfo {
	int64 orderItemId = 1;
	int64 weight = 2;			//商品重量 * qty(本次入库的数量)
	int64 volumeWeight = 3;
	int64 actualWeight = 4;		// 实际重量 * qty
	int64 actualVolumeWeight = 5;
	int64 allWeight = 6;		// 该sku的总重
	int64 allVolumeWeight = 7;	// 该sku的总重
}

// 入库单维度
message ErpDistributeLocation {
	string stockinCode = 1;
	int64 orderId = 2;
	int64 warehouseId = 3;
	int64 shipmentTypeId = 4;
	int64 deliveryTypeId = 5;
	int64 deliveryStationId = 6;
	int64 regionId = 7;
	repeated ErpOrderItemInfo orderItems =8;
	int64 uid = 9;
	bool isPartial = 10;	// 是否部分入库。
	bool isBuyforme = 11; // 服务类型
	int64 customerId = 12; // 会员id
}

message ErpDistributeLocationResp {
	int64 locationId = 1;			// 库位ID
	string locationCode = 2;
}

message ErpStockinRollBack {
	string stockinCode = 1;
	repeated ErpOrderItemInfo orderItems =2;
	int64 uid = 3;
	bool isPartial = 4;
}

message ErpReleaseLocation {
	int64 orderId = 1;
	int64 orderItemId = 2;
	int64 weight = 3;
	int64 volumeWeight = 4;
	int64 oldQty = 5;
	int64 newQty = 6;
	int64 stockinQty = 7;
}

message ErpReleaseSkuItem {
	int64 orderId = 1;
	int64 orderItemId = 2;
	int64 weight = 3; // 商品重量和体积重 那个大选哪个，乘以本次入库数量
	int64 actWeight = 4; // 实际重量和体积重 那个大选哪个，乘以本次入库数量
	bool isBig = 5;
}

message ErpFixStockinBug {
	repeated string codes = 1;  //有问题的入库单
}

message ErpFixStockinBugResp {
	repeated string codes = 2; //处理失败的入库单
}

message ErpRecheckLocation {
	repeated string locIds = 1;
	int32 offset = 2;
	int32 limit = 3;
}

message ErpReleaseStockin {
	string stockinCode = 1;
	repeated ErpReleaseSkuItem skus = 2;
	int64 userId = 3;
}

message ErpExportLocCustomer {
	int64 warehouseId = 1;
}

message ErpExportLocCustomerResp {
	string contentType = 1;
	bytes data = 2;
	string filename = 3;
}

message GetStockInfoByOrderNosReq {
	repeated string items = 1;
}

message GetStockInfoByOrderNosResp {
        map<string,GetStockInfoByOrderNosRespItems> items = 1;
}

message GetStockInfoByOrderNosRespItems {
        repeated GetStockInfoByOrderNosRespItem items = 2;
}

message GetStockInfoByOrderNosRespItem {
        string stockinCode = 1;
        string stockinStatusCode = 2;
        string locationCode = 3;
        string pickingCode = 4;
}

message GetOrderInfoByStockinCodesReq {
	repeated string stockinCodes = 1;
}

message ErpOrderInfo {
	int64 orderId = 1;
	int64 orderItemId = 2;
	int64 orderIdMssql = 3;
	string stockinCode = 4;
}

message GetOrderInfoByStockinCodesResp {
	repeated ErpOrderInfo orderInfos = 1;
}
