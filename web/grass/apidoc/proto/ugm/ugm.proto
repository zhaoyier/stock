syntax = "proto3";
package ugm;

import "common/ezbuy.proto";

service UGM {
    // 获取用户分组列表
    rpc GetGroupList (GetGroupListReq) returns (GetGroupListResp);

    // 创建用户分组（简单）
    rpc CreateGroup (CreateGroupReq) returns (CreateGroupResp);

    // 更新用户分组（主要为标签）
    rpc UpdateGroup (UpdateGroupReq) returns (UpdateGroupResp);

    // 返回处于Ready状态的分组
    rpc GetValidExcludeGroupList (GetValidExcludeGroupListReq) returns (GetValidExcludeGroupListResp);

    // 获取某个用户分组标签
    rpc GetGroup (GetGroupReq) returns (GetGroupResp);

    // 删除用户分组
    rpc ActDeleteGroups (ActDeleteGroupsReq) returns (ActDeleteGroupsResp);

    rpc ActStartGroup (ActStartGroupReq) returns (ActStartGroupResp);

    // 停止同步某个用户分组
    rpc ActStopGroup (ActStopGroupReq) returns (ActStopGroupResp);

    rpc GetLevel2Categories (GetLevel2CategoriesReq) returns (GetLevel2CategoriesResp);

    rpc GetShipInfo (GetShipInfoReq) returns (GetShipInfoResp);

    rpc GetValidVouchers (GetValidVouchersReq) returns (GetValidVouchersResp);

    rpc GetGroupUsers (GetGroupUsersReq) returns (GetGroupUsersResp);

	// 查询用户所属的组
	rpc GetUserGroups (GetUserGroupsReq) returns (GetUserGroupsResp);
	
	rpc GetUserGroupsByCache(GetUserGroupsReq) returns (GetUserGroupsResp) {
		option (common.timeout) = "1s";
		option (common.cache).enableClientSideCache = true;
		option (common.cache).enableServerSideCache = true;
		option (common.cache).cacheExpired = "1800s";
	};

    rpc DownloadGroupUsers (DownloadGroupUsersReq) returns (DownloadGroupUsersResp);

    // -------------------- for internal use --------------------
    rpc NotifyOnGroupReady (NotifyOnGroupReadyReq) returns (NotifyOnGroupReadyResp);

    rpc GetSqlOfGroup (GetSqlOfGroupReq) returns (GetSqlOfGroupResp);

    rpc AddUsersToGroup (AddUsersToGroupReq) returns (AddUsersToGroupResp);
}

// --------------------
message GetGroupListReq {
    string groupName           = 1;
    string createBy            = 2;
    int32 offset               = 3;
    int32 pageSize             = 4;
    repeated GroupState states = 5;
    repeated System systems    = 6;
    Bool isKeepUpdating        = 7;
    Bool isExpired             = 8; // None-都包含 True-只返回过期的 False-只返回不过期的
    bool detailed              = 9; // 为false时，不会返回最后执行情况
    string catalog             = 10;
}

message GetGroupListResp {
    Ret ret = 1;
    int32 total = 2;
    repeated Group groups = 3;
}

message Group {
    int32 id                       = 1;
    string name                    = 2;
    string catalog                 = 3;
    string desc                    = 4;
    int64 expireAt                 = 5;
    repeated System systems        = 6;
    repeated int32 excludeGroups   = 7;
    GroupState state               = 8;
    string createBy                = 9;
    int64 createAt                 = 10;
    string updateBy                = 11;
    int64 updateAt                 = 12;
    GroupSyncPolicy syncPolicy     = 13;
    GroupUpdatePolicy updatePolicy = 14;
    Tag tag                        = 15;
    string fileUrl                 = 16;
    GroupExecLog lastExeclog       = 17;
}

message GroupExecLog {
    GroupExecType type  = 1;
    GroupState state    = 2;
    int32 userAmount    = 3;
    string usersFileUrl = 4;
    int64 endAt         = 5;
    float percent = 6; // 进度运算百分比
}

// --------------------
message CreateGroupReq {
    string groupName = 1;
    string catalog = 2; // SG / MY / TH / ID
}

message CreateGroupResp {
    Ret ret = 1;
    int32 id = 2;
}

// --------------------
message UpdateGroupReq {
    int32 groupId                  = 1;
    Tag tag                        = 2;
    string uploadFile              = 3;
    GroupUpdatePolicy updatePolicy = 4;
    int64 expireAt                 = 5;
    string desc                    = 6;
    repeated System systems        = 7;
    repeated int32 excludeGroups   = 8;
}

message UpdateGroupResp {
    Ret ret = 1;
    GroupState state = 2;
}

// --------------------
message GetValidExcludeGroupListReq {
    string catalog = 1;
}

message GetValidExcludeGroupListResp {
    Ret ret = 1;

    message Group {
        int32 id = 1;
        string name = 2;
    }

    repeated Group groups = 2;
}

// --------------------
message GetGroupReq {
    int32 groupId = 1;
}

message GetGroupResp {
    Ret ret = 1;
    Group group = 2;
}

// --------------------
message ActDeleteGroupsReq {
    repeated int32 groupIds = 1;
}

message ActDeleteGroupsResp {
    Ret ret = 1;
}

// --------------------
message ActStartGroupReq {
    int32 groupId = 1;
}

message ActStartGroupResp {
    Ret ret = 1;
    GroupState state = 2;
}

// --------------------
message ActStopGroupReq {
    int32 groupId = 1;
}

message ActStopGroupResp {
    Ret ret = 1;
    GroupState state = 2;
}

// -------------------- tag --------------------
message PersonInfo {
    Sex sex = 1;
    TimeRange birthday = 2;
    TimeRange registrationTime = 3;
    repeated PrimeType primeTypes = 4;
    repeated MemberLevel memberLevels = 5;
}

message HistoricalBehavior {
    repeated bool everPurchased = 1;
    IntRange purchaseTimes = 2; // 用数组的形式，判断有无传入值
    IntRange purchaseAmount = 3;
    TimeRange lastPurchaseTime = 4;
    repeated Level2Category level2Categories = 5;
    repeated PurchaseType lastPurchaseTypes = 6;
    CartHistoricalBehavior normalCart = 7;
    CartHistoricalBehavior primeCart = 8;
    repeated int32 voucherIds = 9;
    bool isVoucherUsed = 10;
}

message BehaviorData {
    TimeRange timeRange = 1;
    PurchaseData purchaseData = 2;
    MembershipChangeEvent membershipChangeEvent = 3;
    repeated ShipInfo shipInfos = 4;
    ProductComment productComment = 5;
}

message ProductComment {
    Bool everCommented = 1;
	IntRange rank = 2;
    Bool everCommentedWithPicture = 3;
}

message ShipInfo {
    ShipInfoType shipInfoType = 1;

    int32 deliveryTypeId = 2;

    int32 cityId = 3;
    int32 stationId = 4;
}

enum ShipInfoType {
    ShipInfoTypeNone = 0;
    ShipInfoTypeHomeDelivery = 1;
    ShipInfoTypeCollectionStation = 2;
}

message CityStation {
    int32 cityId = 1;
    string cityName = 2;
    repeated CollectionStation stations = 3;
}

message CollectionStation {
    int32 id = 1;
    string name = 2;
}

message Tag {
    PersonInfo personInfo = 1;
    HistoricalBehavior historicalBehavior = 2;
    BehaviorData behaviorData = 3;
}

// -------------------- category --------------------
message Category {
    int64 id = 1;
    string name = 2;
}

message Level2Category {
    Category level = 1;
    repeated Category subLevels = 2;
}

// -------------------- cart historical behavior --------------------
message CartHistoricalBehavior {
    IntRange purchaseTimes = 1;
    IntRange purchaseAmount = 2;
    TimeRange lastAddCartTime = 3;
    IntRange cartWeight = 4;
    IntRange cartAmount = 5;
    repeated Level2Category level2Categories = 6;
    repeated ProductOrigin productOrigins = 7;
}

// -------------------- purchase data --------------------
message PurchaseData {
    repeated bool boughtFlashDeals = 1;
    repeated PurchaseType purchaseTypes = 2;
    repeated ProductOrigin productOrigins = 3;
    IntRange orderQuantity = 4;
    IntRange orderAmount = 5;
    IntRange skuQuantity = 6;
    repeated Level2Category level2Categories = 7;
    IntRange productTotalWeight = 8;
    IntRange moneyPerPayment = 9;
}

// -------------------- enums --------------------
enum GroupState {
    GroupStateNone = 0;
    GroupStateCreated = 1;
    GroupStateEdited = 2;
    GroupStatePending = 3;
    GroupStateExecuting = 4;
    GroupStateFailed = 5;
    GroupStateReady = 6;
    GroupStateStopped = 7;
}

enum GroupSyncPolicy {
    GroupSyncPolicyNone    = 0;
    GroupSyncPolicyTag     = 1;
    GroupSyncPolicyDefined = 2;
}

enum GroupExecType {
    GroupExecTypeNone = 0;
    GroupExecTypeManual = 1;
    GroupExecTypeSchedule = 2;
    GroupExecTypeUpload = 3;
}

enum GroupUpdatePolicy {
    GroupUpdatePolicyNone   = 0;
    GroupUpdatePolicyHourly = 1;
    GroupUpdatePolicyDaily  = 2;
}

enum Sex {
    SexNone = 0;
    SexMale = 1;
    SexFemale = 2;
}

enum PrimeType {
    PrimeTypeNone = 0;
    PrimeTypeYearly = 1;
    PrimeTypeTrial = 2;
}

enum MemberLevel {
    MemberLevelNone = 0;
    MemberLevelNormal = 1;
    MemberLevelVip = 2;
    MemberLevelSVip = 3;
}

enum System {
    SystemNone      = 0;
    SystemEDM       = 1;
    SystemPush      = 2;
    SystemSMS       = 3;
    SystemVoucher   = 4;
    SystemPopUp     = 5;
    SystemFacebook  = 6;
    SystemJackpot  = 7;
    SystemBanner = 8;
    SystemActivity = 9;
    SystemShip4Address = 10;
}

enum PurchaseType {
    PurchaseTypeNone = 0;
    PurchaseTypePrime = 1;
    PurchaseTypeEzbuy = 2;
    PurchaseTypeBuy4me = 3;
    PurchaseTypeShip4me = 4;
    PurchaseTypeLocalSales = 5;
}

enum ProductOrigin {
    ProductOriginNone = 0;
    ProductOriginSG = 1;
    ProductOriginCN = 2;
    ProductOriginKR = 3;
    ProductOriginUS = 4;
    ProductOriginTW = 5;
    ProductOriginMY = 6;
}

enum MembershipChangeEvent {
    MembershipChangeEventNone = 0;
    MembershipChangeEventBecomePrimeAnnual = 1;
    MembershipChangeEventBecomePrimeTrial = 2;
    MembershipChangeEventPrimeAnnualExpired = 3;
    MembershipChangeEventPrimeTrialExpired = 4;
}

enum Bool {
    BoolNone    = 0;
    BoolFalse   = 1;
    BoolTrue    = 2;
}

// -------------------- category data --------------------
message GetLevel2CategoriesReq {}

message GetLevel2CategoriesResp {
    Ret ret = 1;
    repeated Level2Category categories = 2;
}

message GetShipInfoReq {
    string catalog = 1;
}

message GetShipInfoResp {
    Ret ret = 1;
    repeated DeliveryType deliveryTypes = 2;
    repeated CityStation cityStations = 3;
}

message DeliveryType {
    int32 id = 1;
    string name = 2;
}

// -------------------- voucher --------------------
message GetValidVouchersReq {}

message GetValidVouchersResp {
    Ret ret = 1;
    repeated int32 voucherIds = 2;
}

// --------------------
message GetGroupUsersReq {
    int32 groupId = 1;
    int32 offset = 2;
    int32 limit = 3; // Max 5000
    bool ignoreExpired = 4;
}

message GetGroupUsersResp {
    Ret ret = 1;
    int32 total = 2;
    repeated User users = 3;
}

message User {
    int32 id = 1;
    string nickname = 2;
    string email = 3;
}

// --------------------
message GetUserGroupsReq {
    int32 userId = 1;
    bool ignoreExpired = 2;
}

message GetUserGroupsResp {
    Ret ret = 1;
    repeated int32 groupIds = 2;
}

// --------------------
message DownloadGroupUsersReq {
    int32 groupId = 1;
}

message DownloadGroupUsersResp {
    Ret ret = 1;
    string fileUrl = 2;
}

// -------------------- for internal use --------------------
message NotifyOnGroupReadyReq {
    int32 groupId = 1;
}

message NotifyOnGroupReadyResp {
    Ret ret = 1;
}

// -------------------- for internal use --------------------
message GetSqlOfGroupReq {
    int32 groupId = 1;
    string groupName = 2;
}

message GetSqlOfGroupResp {
    Ret ret = 1;

    message Sql {
        string script = 1;
        repeated string params = 2;
    }

    repeated Sql sqls = 2;
}

// -------------------- for internal use --------------------
message AddUsersToGroupReq {
    int32 groupId = 1;
    string catalog = 2;
    repeated int32 userIds = 3;
}

message AddUsersToGroupResp {
    Ret ret = 1;
}

// -------------------- common --------------------
message TimeRange {
    repeated int64 from = 1;
    repeated int64 to = 2;
    repeated int64 offsetDayFrom = 3; // 相对时间，以天为单位，如：过去1-3天，offsetDayFrom为3，offsetDayTo为1
    repeated int64 offsetDayTo = 4;
}

message IntRange {
    repeated int64 from = 1;
    repeated int64 to = 2;
}

message FloatRange {
    float from = 1;
    float to = 2;
}

message Ret {
    RetCode code = 1;
    string errMsg = 2;
}

enum RetCode {
    Ok = 0;
    Error = 1;
}
